From 9608629d7ee42dd65437d2e7fad5c91438d7de4b Mon Sep 17 00:00:00 2001
From: Erik Verbruggen <erik.verbruggen@theqtcompany.com>
Date: Thu, 26 Feb 2015 13:00:39 +0100
Subject: OSX: fix leaks due to missing NSAutoreleasePool
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

env OBJC_DEBUG_MISSING_POOLS=YES qtcreator

Change-Id: Ibbe5f42af5b94a439be3f0dd0f2b6e34bb1afd3f
Reviewed-by: Morten Johan SÃ¸rvig <morten.sorvig@theqtcompany.com>
---
 src/corelib/tools/qlocale_mac.mm                      | 13 +++++++++++++
 .../fontdatabases/mac/qcoretextfontdatabase.mm        | 14 ++++++++++++++
 src/plugins/platforms/cocoa/qcocoahelpers.mm          |  1 +
 src/plugins/platforms/cocoa/qcocoaintegration.mm      |  2 ++
 src/plugins/platforms/cocoa/qcocoamenu.mm             |  2 ++
 src/plugins/platforms/cocoa/qcocoamenubar.mm          |  2 ++
 src/plugins/platforms/cocoa/qcocoamenuitem.mm         |  2 ++
 src/plugins/platforms/cocoa/qcocoanativeinterface.mm  |  1 +
 src/plugins/platforms/cocoa/qcocoasystemsettings.mm   |  3 +++
 src/widgets/styles/qmacstyle_mac.mm                   | 19 +++++++++++++++++++
 10 files changed, 59 insertions(+)

--- a/qtbase/src/corelib/tools/qlocale_mac.mm
+++ b/qtbase/src/corelib/tools/qlocale_mac.mm
@@ -56,6 +56,18 @@
 };
 }
 
+namespace {
+class AutoReleasePool
+{
+public:
+    AutoReleasePool(): pool([[NSAutoreleasePool alloc] init]) {}
+    ~AutoReleasePool() { [pool drain]; }
+
+private:
+    NSAutoreleasePool *pool;
+};
+}
+
 /******************************************************************************
 ** Wrappers for Mac locale system functions
 */
--- a/qtbase/src/platformsupport/fontdatabases/mac/qcoretextfontdatabase.mm
+++ b/qtbase/src/platformsupport/fontdatabases/mac/qcoretextfontdatabase.mm
@@ -60,6 +60,18 @@
 };
 }
 
+namespace {
+class AutoReleasePool
+{
+public:
+    AutoReleasePool(): pool([[NSAutoreleasePool alloc] init]) {}
+    ~AutoReleasePool() { [pool drain]; }
+
+private:
+    NSAutoreleasePool *pool;
+};
+}
+
 // this could become a list of all languages used for each writing
 // system, instead of using the single most common language.
 static const char *languageForWritingSystem[] = {
@@ -213,6 +225,7 @@
         QPlatformFontDatabase::registerFontFamily(familyName);
 
 #if defined(Q_OS_OSX)
+        AutoReleasePool pool;
         QString localizedFamilyName = QString::fromNSString([[NSFontManager sharedFontManager] localizedNameForFamily:(NSString*)familyNameRef face:nil]);
         if (familyName != localizedFamilyName)
             QPlatformFontDatabase::registerAliasToFontFamily(familyName, localizedFamilyName);
@@ -455,6 +468,8 @@
 
     AutoReleasePool pool;
 
+    AutoReleasePool pool;
+
     static QHash<QString, QStringList> fallbackLists;
 
     if (!family.isEmpty()) {
--- a/qtbase/src/plugins/platforms/cocoa/qcocoanativeinterface.mm
+++ b/qtbase/src/plugins/platforms/cocoa/qcocoanativeinterface.mm
@@ -234,6 +234,7 @@
 
 void QCocoaNativeInterface::setDockMenu(QPlatformMenu *platformMenu)
 {
+    QCocoaAutoReleasePool pool;
     QCocoaMenu *cocoaPlatformMenu = static_cast<QCocoaMenu *>(platformMenu);
     NSMenu *menu = cocoaPlatformMenu->nsMenu();
     [NSApp QT_MANGLE_NAMESPACE(qt_setDockMenu): menu];
--- a/qtbase/src/plugins/platforms/cocoa/qcocoasystemsettings.mm
+++ b/qtbase/src/plugins/platforms/cocoa/qcocoasystemsettings.mm
@@ -36,6 +36,8 @@
 #include "qcocoaautoreleasepool.h"
 #include "qcocoahelpers.h"
 
+#include "qcocoaautoreleasepool.h"
+
 #include <QtCore/private/qcore_mac_p.h>
 #include <QtGui/qfont.h>
 
--- a/qtbase/src/plugins/platforms/cocoa/qcocoawindow.mm
+++ b/qtbase/src/plugins/platforms/cocoa/qcocoawindow.mm
@@ -1666,6 +1666,8 @@
     if (!window)
         return;
 
+    QCocoaAutoReleasePool pool;
+
     if (!m_drawContentBorderGradient) {
         [window setStyleMask:[window styleMask] & ~NSTexturedBackgroundWindowMask];
         [[[window contentView] superview] setNeedsDisplay:YES];
