# -*- coding: utf-8; mode: tcl; tab-width: 4; truncate-lines: t; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# kate: backspace-indents true; indent-pasted-text true; indent-width 4; keep-extra-spaces true; remove-trailing-spaces modified; replace-tabs true; replace-tabs-save true; syntax Tcl/Tk; tab-indents true; tab-width 4;

PortSystem          1.0
PortGroup           wxWidgets 1.0

name                audacity-devel
conflicts           audacity
version             2.1.2

PortGroup           github 1.0
github.setup        audacity audacity ${version} Audacity-
github.tarball_from releases
master_sites        https://github.com/audacity/audacity/archive/
distname            Audacity-${version}
checksums           rmd160  4e0c508b8edd24935a235c0b1a636c4ef1ae59a9 \
                    sha256  90007b50cdc3885607b1afef2f158777a61c1658e869a88ec4d98c59c133f9bd

post-extract {
    file rename ${workpath}/audacity-Audacity-${version} ${workpath}/${distname}
}

categories          audio

description         A Free, Cross-Platform Digital Audio Editor

long_description    Audacity is a free, easy-to-use, multi-track audio editor and recorder \
    for Windows, Mac OS X, GNU/Linux and other operating systems. The interface is translated \
        into many languages. You can use Audacity to: \n\
        Record live audio. \n\
        Record computer playback on any Windows Vista or later machine. \n\
        Convert tapes and records into digital recordings or CDs. \n\
        Edit WAV, AIFF, FLAC, MP2, MP3 or Ogg Vorbis sound files. \n\
        AC3, M4A/M4R (AAC), WMA and other formats supported using optional libraries. \n\
        Cut, copy, splice or mix sounds together. \n\
        Numerous effects including change the speed or pitch of a recording. \n\
        And more!

platforms           darwin
license             GPL-2
maintainers         gmail.com:rjvbertin openmaintainer
universal_variant   no
use_parallel_build  no

homepage            http://www.audacityteam.org/

wxWidgets.use       wxWidgets-3.0

depends_build-append \
                    port:pkgconfig port:cmake port:python27
depends_lib-append  port:wxWidgets-3.0 port:harfbuzz port:freetype port:ffmpeg port:expat \
                    port:flac port:libid3tag port:libmad port:lame port:twolame port:libogg \
                    port:portaudio port:libsndfile port:soundtouch port:libvorbis port:soxr
# audacity could use port:lv2 and port:lilv but would also require a port:suil for that to be possible.

patch.pre_args      -Np1
# debian/patches/clang-ftbfs.patch
# avoid-toolbar-background-corruption.diff
# patch-ambiguous-bitand.diff
# patch-no-mac-filedialogprivate.diff
# patch-attempt2avoid-meter-corruption.diff
patchfiles-append   debian/patches/fix-minsrc-autoreconf.patch              \
                    debian/patches/workaround-wxwidgets-fit-recovery.patch  \
                    add_missing_newline.diff                                \
                    libvamp-Makefile-for-osx.diff                           \
                    src-Makefile-for-osx.diff                               \
                    FFMpegh_build_against_ffmpeg.diff                       \
                    portaudio-no-universal-build.diff                       \
                    buildinfo-clarify-no-gstreamer.diff                     \
                    add_enGB_translation.diff                               \
                    patch-avoid-clang-choke-on-confbase.diff                \
                    patch-waf-use-python27.diff                             \
                    patch-no-rtld_deepbind.diff                             \
                    patch-more-decent-font-sizes.diff

# address issues in the build system:
# - build and link VSTControlOSX.mm instead of the GTk interface
# - address a visibility issue with the slider_array variable in libnyquist
# - make the AudioUnits plugin support build; on 64bit and also include AUControl.mm
patchfiles-append   patch-vstcontrolosx.diff \
                    patch-libnyquist-symbol-visibility.diff \
                    patch-fix-audiounits.diff

post-patch {
    reinplace -W ${worksrcpath} "s|/opt/local|${prefix}|g" lib-src/lv2/lv2/waf lib-src/lv2/lv2/wscript
    reinplace -W ${worksrcpath} "s|/usr/local|${prefix}|g" src/effects/ladspa/LadspaEffect.cpp \
                                src/export/ExportMP3.cpp \
                                lib-src/lv2/lilv/wscript lib-src/lv2/lilv/test/lilv_test.c
    reinplace -W ${worksrcpath} "s|/Library/Audio/Plug-Ins/Vamp|/Library/Audio/Plug-Ins/Vamp:${prefix}/lib/vamp|g" \
                                lib-src/libvamp/src/vamp-hostsdk/PluginHostAdapter.cpp
    reinplace -W ${worksrcpath} "s|/Library/Application Support/audacity/libs|${prefix}/lib|g" src/FFmpeg.h
    reinplace -W ${worksrcpath} "s| -Werror||g" lib-src/portaudio-v19/configure.in \
                                lib-src/portaudio-v19/configure
    # audacity 2.1.2 contains C++ files that include system SDK headers and ObjC code on OS X;
    # they must thus be built as ObjC++
    set fake_objcpp { \
        {CommandManager src/commands {src/Makefile.in src/Makefile.am}} \
        {Effect src/effects {src/Makefile.in src/Makefile.am}} \
        {LV2Effect src/effects/lv2 {src/Makefile.in src/Makefile.am}} \
    }
    foreach mm ${fake_objcpp} {
        set f [lindex ${mm} 0]
        set d [lindex ${mm} 1]
        set mk [lindex ${mm} 2]
        foreach m ${mk} {
            reinplace -W ${worksrcpath} "s|/${f}.cpp|/${f}.mm|g" ${m}
        }
        if {![file exists ${worksrcpath}/${d}/${f}.mm]} {
            ln -s ${f}.cpp ${worksrcpath}/${d}/${f}.mm
        }
        reinplace -W ${worksrcpath} "s|/VSTControlGTK.cpp|/VSTControlOSX.mm|g" \
            src/Makefile.in src/Makefile.am
    }
}

configure.args-append   --disable-dependency-tracking --enable-shared --disable-static --enable-sse --with-ffmpeg \
                        --with-lam --with-libflac --with-libmad --with-soundtouch --with-twolame --with-libvorbis \
                        --with-lv2=local --disable-quicktime --disable-universal_binary CPPFLAGS=-I${prefix}/include \
                        --with-sbsms=local --with-libsoxr --with-libvamp=local --with-widgetextra=local --with-portmixer \
                        --enable-audiounits \
                        WX_CONFIG=${wxWidgets.wxconfig}

