# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           LTO 1.0
PortGroup           cxx11 1.1

name                copperspice

categories          devel
platforms           darwin linux
maintainers         gmail.com:rjvbertin openmaintainer
license             LGPL-2.1
use_bzip2           yes

compiler.cxx_standard 2017

pre-extract {
    # CopperSpice doesn't properly pack their tarballs
    xinstall -m 755 -d ${worksrcpath}
    extract.post_args-append \
                    -C ${worksrcpath}
}

cmake.save_configure_cmd "log too"

patch.pre_args      -Np1

subport ${name} {
    version         1.6.3
# find a clever way to set BUILD_DATE so it has more meaning than a fixed-by-the-port value
# but still doesn't interfere with ccache (maintainer convenience)
    set BUILD_DATE  2020-07-11

    description     a cross-platform middleware derived and diverged from Qt

    long_description \
                    CopperSpice is a set of individual libraries which can be used to develop cross \
                    platform software applications in C++. It is a totally open source project that \
                    was initially derived from the Qt framework. Over the last several years CopperSpice \
                    has completely diverged, with a goal of providing a first class GUI library to unite \
                    the C++ community. 

    master_sites    https://download.copperspice.com/${subport}/source/
    checksums       rmd160  4909ee0c88967f64974c0662d36270d1a69adf20 \
                    sha256  e207fcb58fbb0a6ca0fd9c3befdb1553a4e6a9a19c08e21ccf377bf3ce824508
#                     size    16804699

    depends_lib-append \
                    port:openssl \
                    port:zlib \
                    port:glib2 \
                    port:libiconv
    platform linux {
        depends_lib-append \
                    port:alsa-lib \
                    port:pulseaudio \
                    port:xorg-libxcb \
                    port:libxkbcommon \
                    port:gstreamer1 \
                    port:gstreamer1-gst-libav \
                    port:gstreamer1-gst-plugins-base \
                    port:gstreamer1-gst-plugins-good \
                    port:mesa \
                    port:libxml2
    }
    platform darwin {
        # TODO: postgresql and mysql variants
        # TODO: depend on cups?
        # TODO: figure out X11 dependencies
        depends_lib-append \
                    port:fontconfig
    }

    patchfiles-append \
                    copperspice/patch-macports-build.diff

    configure.env-append \
                    "ICONVDIR=${prefix}"

    configure.args-append \
                    -DBUILD_DATE="${BUILD_DATE}" \
                    -DCMAKE_INSTALL_BINDIR=libexec/CopperSpice/bin \
                    -DCMAKE_INSTALL_INCLUDEDIR=include/CopperSpice
    post-destroot {
        reinplace "s|\$\{_IMPORT_PREFIX\}/include/Qt|${prefix}/include/CopperSpice;$\{_IMPORT_PREFIX\}/include/CopperSpice/Qt|g" \
                    ${destroot}${prefix}/lib/cmake/CopperSpice/CopperSpiceLibraryTargets.cmake
    }
}

subport PepperMill {
    version         1.6.0
# find a clever way to set BUILD_DATE so it has more meaning than a fixed-by-the-port value
# but still doesn't interfere with ccache (maintainer convenience)
    set BUILD_DATE  2020-07-11

    description     a Qt4 translator for CopperSpice

    long_description \
                    The PepperMill utility is a translator and is run one time on your C++ header files. \
                    It will convert your application header files to CopperSpice header files and change \
                    the syntax of Signal and Slot declarations, properties, enums, and several other constructs \
                    which involve registration. The conversion will update your existing source to work with CopperSpice. 

    master_sites    https://download.copperspice.com/peppermill/source/
    distname        ${subport}-${version}
    checksums       rmd160  06fec54997314a9727f99268c2e62a82f11c259c \
                    sha256  2273a09606bfe0f2100a7368dd9ad887a4cb2870ba816942517a2e6d390edfa0
#                     size    62977

    depends_lib-append \
                    port:copperspice
    patchfiles-append \
                    peppermill/patch-macports-build.diff
    configure.args-append \
                    -DBUILD_DATE="${BUILD_DATE}" \
                    -DCMAKE_INSTALL_BINDIR=libexec/CopperSpice/bin
}
