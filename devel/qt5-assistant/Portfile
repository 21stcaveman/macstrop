# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           qmake5 1.0

name                qt5-assistant
set module          qttools
version             5.9.2

set branch          [join [lrange [split ${version} .] 0 1] .]

categories          devel aqua
description         A standalone version of Qt's Assistant
long_description    Qt Assistant is the documentation browser from the QtTools component. \
                    Its full feature set and optimum rendering depends on the now deprecated \
                    QtWebKit component.
universal_variant   no

maintainers         gmail.com:rjvbertin mk openmaintainer
platforms           darwin linux
license             LGPL-3

homepage            http://qt.io
distname            ${module}-opensource-src-${version}
master_sites        http://download.qt.io/official_releases/qt/${branch}/${version}/submodules
use_xz              yes

checksums           rmd160  42d6cdcaf62ca929d840ba8204acec0cc9b05bec \
                    sha256  2bb996118b68e9939c185a593837e5a41bb3667bf5d4d5134fac02598bd2d81a

# a convenience procedure to register conflicts among the different Qt5 ports:
# for instance: [qt5_port_conflicts {qtbase x11}]
# adapted from port:qt5-kde
proc qt5_port_conflicts {components} {
    global available_qt5_versions subport
    set cnfls {}
    foreach suffix {"" "-devel"} {
        foreach comp ${components} {
            foreach v ${available_qt5_versions} {
                if {"${v}-${comp}" ne "${subport}"} {
                    if {${comp} ne "" && ${comp} ne "qtbase"} {
                        set cnfls [lappend cnfls ${v}-${comp}]
                        set cnfls [lappend cnfls ${v}-kde${suffix}-${comp}]
                    } else {
                        set cnfls [lappend cnfls ${v}-qtbase]
                        set cnfls [lappend cnfls ${v}-kde${suffix}]
                    }
                }
            }
        }
    }
    return ${cnfls}
}

options                     extract_components
default extract_components  {}
proc collect_extract_args {} {
    foreach comp [option extract_components] {
        extract.post_args-append ${comp}
    }
    ui_info "Exclusive components: [option extract_components]"
}
pre-extract {
    collect_extract_args
}
extract.pre_args-append -T 0
platform linux {
    if {[file exists ${prefix}/bin/bsdtar]} {
        extract.post_args | ${prefix}/bin/bsdtar --no-same-owner -xf -
    }
}

conflicts-append        [qt5_port_conflicts assistant] ${name}-devel

qt5.depends_component   qtwebkit

extract_components-append \
                        ${distname}/src/assistant ${distname}/src/shared

patch.pre_args          -Np1

patchfiles-append       patch-qttools-assistant-standalone-build.diff \
                        patch-assistant-fontpanel.diff

default configure.dir   {${workpath}/build}
configure.pre_args-append \
                        ../${worksrcdir}/src/assistantCD/assistant.pro
default build.dir       {${workpath}/build}

destroot {
    xinstall -m 755 -d ${destroot}${qt_apps_dir}
    if {${os.platform} eq "darwin"} {
        file copy ${build.dir}/assistant/Assistant.app ${destroot}${qt_apps_dir}
        qt5.add_app_wrapper assistant-qt5 Assistant
    } else {
        xinstall -m 755 ${build.dir}/assistant/assistant ${destroot}${qt_apps_dir}
        qt5.add_app_wrapper assistant-qt5 assistant assistant ${qt_apps_dir}
    }
}
