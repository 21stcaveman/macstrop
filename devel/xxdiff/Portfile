# -*- coding: utf-8; mode: tcl; c-basic-offset: 4; indent-tabs-mode: nil; tab-width: 4; truncate-lines: t -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id: Portfile 103303 2013-02-21 06:52:40Z jmr@macports.org $

PortSystem          1.0

name                xxdiff
version             4.0
categories          devel
license             GPL-2+
platforms           darwin
maintainers         nomaintainer
description         xxdiff is a graphical merging tool
long_description    xxdiff is a graphical browser for viewing the \
                    differences between two or three files, or between two \
                    directories, and can be used to produce a merged version.

homepage            http://furius.ca/xxdiff/

fetch.type          hg
hg.url              https://bitbucket.org/blais/xxdiff
hg.tag              b193168bad98

depends_lib         port:bison \
                    port:flex

patchfiles-append   add-accelerators.patch

subport ${name}-qt5 {}

if {${subport} ne "${name}-qt5"} {
    PortGroup			qt4 1.0
    patchfiles-append   patch-xxdiffpro.diff
    conflicts           "${name}-qt5"
} else {
    PortGroup			qt5 1.0
    patchfiles-append   qt5/patch-xxdiffpro.diff \
                        qt5/patch-cmdline.diff \
                        qt5/patch-use-qt5.diff \
                        qt5/patch-restore-style.diff
    conflicts           ${name}
    post-configure {
        # remove the stubs created in the pre-configure phase
        file delete ${configure.dir}/resParser_lex.cpp ${configure.dir}/resParser_lex.h
        file delete ${configure.dir}/resParser_yacc.cpp ${configure.dir}/resParser_yacc.h
    }
}

post-patch {
    reinplace "s|@@QT_INCLUDES_DIR@@|${qt_includes_dir}|g" ${worksrcpath}/src/xxdiff.pro
}

patchfiles-append   patch-Makefiles.diff
configure.dir       ${workpath}/build
configure.cmd       make
configure.pre_args  -f ${worksrcpath}/src/Makefile.bootstrap QMAKE=${qt_qmake_cmd} MAKEDIR=${worksrcpath}/src
build.dir           ${configure.dir}
#use_parallel_build  no

pre-configure {
    file mkdir ${configure.dir}
    if {${subport} eq "${name}-qt5"} {
        # this seems to be necessary to ensure both parsers will be generated before their headerfiles are required
        system "touch ${configure.dir}/resParser_lex.cpp ${configure.dir}/resParser_lex.h"
        system "touch ${configure.dir}/resParser_yacc.cpp ${configure.dir}/resParser_yacc.h"
    }
}

destroot {
    # Destroot xxdiff.
    xinstall -d ${destroot}${qt_apps_dir}
    copy "${build.dir}/bin/xxdiff.app"   ${destroot}${qt_apps_dir}/
    xinstall ${worksrcpath}/src/xxdiff.1 ${destroot}${prefix}/share/man/man1
    xinstall ${filespath}/xxdiff.sh ${destroot}${prefix}/bin/xxdiff
    reinplace "s|@@QT_APPS_DIR@@|${qt_apps_dir}|g" ${destroot}${prefix}/bin/xxdiff
}

variant doc description {Install documentation} {}
if { [variant_isset doc] } {
    # Destroot xxdiff documentation.
    post-destroot {
        xinstall -d ${destroot}${prefix}/share/doc
        copy ${worksrcpath}/doc ${destroot}${prefix}/share/doc/${name}
        delete ${destroot}${prefix}/share/doc/${name}/Makefile
        delete ${destroot}${prefix}/share/doc/${name}/xxdiff-scripts.txt
        delete ${destroot}${prefix}/share/doc/${name}/xxdiff-scripts.html
    }
}

