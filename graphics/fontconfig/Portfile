# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 118682 2014-04-08 02:56:30Z ryandesign@macports.org $
# $Id: Portfile 152719 2016-09-15 11:06:06Z ryandesign@macports.org $

PortSystem                  1.0

name                        fontconfig

subport "${name}-ultimate" {
    supported_archs         noarch
}

categories                  graphics
platforms                   darwin

# # 2015-12-06 is identical to 2015-08-25; only updating to keep in sync with the freetype-infinality version
# set INFRELEASE              2015-12-06
# set INFPATCHES              {01-configure.patch \
#                             02-configure.ac.patch \
#                             03-Makefile.in.patch \
#                             04-Makefile.conf.d.patch \
#                             05-Makefile.am.in.patch \
#                             06-missing_mans.patch}
set INFRELEASE              2016-04-22
set INFPATCHES              {01-configure.patch \
                            02-configure.ac.patch \
                            03-Makefile.in.patch \
                            04-Makefile.conf.d.patch \
                            05-Makefile.am.in.patch}


if {${subport} eq "${name}-ultimate"} {
    fetch.type                  git
    if {[file exists ${filespath}/fontconfig-ultimate-git/.git]} {
        git.url                 ${filespath}/fontconfig-ultimate-git
#         git.branch              254b688f96d4a37f78fb594303a43160fc15c7cd
        git.branch              c0e90598b4a50a92432268ccc442c2e067a54924
    } else {
        PortGroup               github 1.0
        github.setup            bohoomil fontconfig-ultimate c0e90598b4a50a92432268ccc442c2e067a54924
    }
    name                        fontconfig-ultimate
    set fc_vers                 [split ${INFRELEASE} "-"]
    version                     [lindex ${fc_vers} 0].[lindex ${fc_vers} 1].[lindex ${fc_vers} 2]
    license                     MIT
    homepage                    http://bohoomil.com
    platforms                   darwin

    description                 fontconfig-infinality-ultimate & fonts

    long_description            Fontconfig is a library for configuring and \
                                customising font access. Fontconfig-ultimate is a collection \
                                of configuration files that leverage the power of the Infinality \
                                patches to FreeType to provide the ultimate experience in \
                                customisable font rendering quality. \
                                This port provides the configuration files\; it requires fontconfig \
                                to be installed with the +infinality variant.
    installs_libs               no
    supported_archs             noarch

    distname                    ${INFRELEASE}

    if {${fetch.type} ne "git"} {
        master_sites            https://github.com/bohoomil/fontconfig-ultimate/archive
        checksums               rmd160  40c63138ef4e652628e3b79dab0976338d9611c1 \
                                sha256  688ea5cec173cc26743ba0de2cc2b4f8db838bd5cd714c33f7b66bcb896bcfbc
    }

    depends_lib                 port:freetype-infinality
    depends_run                 port:bash

    use_configure               no
    # this appears to be required despite an empty build block!
    build.cmd                   echo
    configure {}
    build {}
    worksrcdir                  ${name}-${distname}
    patchfiles                  patch-presets-nocolours.diff

    post-destroot {
        xinstall -m 0755 -d ${destroot}${prefix}/share/fonts/fontconfig-ultimate/${INFRELEASE}
        copy ${worksrcpath}/conf.d.infinality ${destroot}${prefix}/share/fonts/fontconfig-ultimate/${INFRELEASE}
        reinplace "s|\"/etc|\"${prefix}/etc|g" ${worksrcpath}/fontconfig_patches/fc-presets
        reinplace "s|/bin/bash|${prefix}/bin/bash|g" ${worksrcpath}/fontconfig_patches/fc-presets
        foreach f {CHANGELOG fc-presets fonts-settings free ms} {
            copy ${worksrcpath}/fontconfig_patches/${f} ${destroot}${prefix}/share/fonts/fontconfig-ultimate/${INFRELEASE}
        }
        copy ${worksrcpath}/fontconfig_patches/combi ${destroot}${prefix}/share/fonts/fontconfig-ultimate/${INFRELEASE}/combi-complete
        copy ${worksrcpath}/doc/fontconfig-infinality-ultimate/fontconfig-global/combi-minimal ${destroot}${prefix}/share/fonts/fontconfig-ultimate/${INFRELEASE}/combi
#         copy -force ${worksrcpath}/fontconfig_patches/00-upstream_2.11.93.patch ${filespath}/
        foreach f ${INFPATCHES} {
            copy -force ${worksrcpath}/fontconfig_patches/${f} ${filespath}/${f}.${INFRELEASE}
        }
        # patch a patchfile that was written for fontconfig 2.11.95
        system -W ${filespath} "patch -Np0 -i patch-04-for-fc1121.diff"
    }

    notes-append "fontconfig must be now be (re)build and (re)installed with the +infinality variant."

    livecheck.type              none
    #livecheck.url               https://github.com/bohoomil/fontconfig-ultimate/releases
    #livecheck.version           ${INFRELEASE}
    #livecheck.regex             (\\d+(\\-\\d+)+).zip
} else {
    PortGroup                   muniversal 1.0

#     set fversion                2.11.1
    set fversion                2.12.1
    version                     ${fversion}
    revision                    1
    maintainers                 ryandesign
    license                     fontconfig
    homepage                    https://www.freedesktop.org/wiki/Software/fontconfig/
    platforms                   darwin
    use_parallel_build          yes

    description                 An XML-based font configuration API for X Windows

    long_description            Fontconfig is a library for configuring and \
                                    customising font access.

    master_sites                https://www.freedesktop.org/software/fontconfig/release/
    use_bzip2                   yes

#     checksums                   ${distname}${extract.suffix} \
#                                 rmd160  9d0a242ec05737f5dba3949ffe095f3c100217c7 \
#                                 sha256  dc62447533bca844463a3c3fd4083b57c90f18a70506e7a9f4936b5a1e516a99
    checksums                   ${distname}${extract.suffix} \
                                rmd160  66907dbb317309bcb5013ea45c53dbf5050e6376 \
                                sha256  b449a3e10c47e1d1c7a6ec6e2016cca73d3bd68fbbd4f0ae5cc6b573f7d6c7f3

    depends_build               port:pkgconfig

    depends_lib                 port:libiconv \
                                port:expat \
                                port:freetype

    if {${os.platform} eq "darwin" && ${os.major} < 9} {
        set add_fonts           /usr/X11R6/lib/X11/fonts
    } else {
        set add_fonts           /usr/X11/lib/X11/fonts
    }
    lappend add_fonts           ${prefix}/share/fonts
    set docdir                  ${prefix}/share/doc/${name}

    # using p1 patches is going to make life easier with the Infinality patches:
    patch.pre_args              -p1
    patchfiles                  patch-docbook-4.2.diff
    patchfiles-append           patch-src-fcweight.c.diff
    patchfiles-append           patch-src-fccache.c.diff

    configure.args              --disable-silent-rules HASDOCBOOK=no

    # We put this into a pre-configure block so it can be evaluated _after_ platform selection.
    pre-configure {
        configure.args-append   --with-add-fonts=[join ${add_fonts} ,]
    }

    post-destroot {
        xinstall -d ${destroot}${docdir}
        xinstall -m 0644 -W ${worksrcpath} \
            AUTHORS \
            COPYING \
            ChangeLog \
            NEWS \
            README \
            ${destroot}${docdir}

            if {[variant_isset infinality]} {
                catch {eval exec sh ${filespath}/install-conf-files.sh ${prefix} ${workpath} ${destroot} ${INFRELEASE}} result
                ui_debug "install-conf-files.sh : $result"
            }
    }

    post-activate {
        # fc-cache can fail due to /Network/Library/Fonts being unavailable, so force success.
        system "${prefix}/bin/fc-cache -sv || true"
        system "${prefix}/bin/fc-cache -v || true"
    }

    platform macosx {
        lappend add_fonts       /Library/Fonts \
                                /Network/Library/Fonts \
                                /System/Library/Fonts
    }

    merger_arch_flag            no
    merger_arch_compiler        yes
    if {${os.arch} eq "i386"} {
        if { ${os.major} >= 10 } {
            set merger_configure_args(ppc) --with-arch=ppc
            set merger_configure_env(ppc)  CC_FOR_BUILD=${configure.cc}
        }
        set merger_configure_args(ppc64)   --with-arch=ppc64
        set merger_configure_env(ppc64)    CC_FOR_BUILD=${configure.cc}
    } else {
        set merger_configure_args(i386)    --with-arch=i386
        set merger_configure_args(x86_64)  --with-arch=x86_64
        set merger_configure_env(i386)     CC_FOR_BUILD=${configure.cc}
        set merger_configure_env(x86_64)   CC_FOR_BUILD=${configure.cc}
    }

    if {[file exists ${prefix}/share/fonts/fontconfig-ultimate]} {
        default_variants    +infinality
    }

    set TEMPLINFDIR ${prefix}/etc/fonts/conf.avail.infinality
    variant infinality description {patched for improved font rendering, bohoomil ultimate style} {
#         version             2.11.93
        worksrcdir          ${name}-${fversion}
        distname            ${name}-${fversion}
#         revision            [expr ${revision} + 3]
        # make sure we get the dependency order right, in case the user hasn't already installed freetype:
        depends_lib-delete          port:freetype
        depends_lib-append          port:fontconfig-ultimate port:freetype-infinality port:freetype
        depends_build-append        port:gperf
        # point configure to the MacPorts python interpreter that has the lxml package:
        # we use depends_fetch below because it seems to accept the non-universal python and py-lxml packages
        # at least after one has installed them by hand, rather than imposing +universal if we're building
        # fontconfig +universal...!
        global PYTHON
        global PYVERSION
        global PY2TO3
        if {[file exists ${prefix}/Library/Frameworks/Python.framework/Versions/3.4/lib/python3.4/site-packages/lxml]} {
            depends_fetch-append             port:py34-lxml
            depends_skip_archcheck-append    port:py34-lxml
            set PYVERSION           3.4
            set PYTHON              ${prefix}/bin/python${PYVERSION}
            set PY2TO3              yes
        } elseif {[file exists ${prefix}/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site-packages/lxml] \
                || ([file exists ${prefix}/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7] && \
                    ![file exists ${prefix}/Library/Frameworks/Python.framework/Versions/3.4/lib/python3.4]) } {
            # lxml installed for py2.7 *or* py2.7 is installed and py3.4 is not
            depends_fetch-append             port:py27-lxml
            depends_skip_archcheck-append    port:py27-lxml
            set PYVERSION           2.7
            set PYTHON              ${prefix}/bin/python${PYVERSION}
            set PY2TO3              no
        } else {
            depends_fetch-append             port:py34-lxml
            depends_skip_archcheck-append    port:py34-lxml
            set PYVERSION           3.4
            set PYTHON              ${prefix}/bin/python${PYVERSION}
            set PY2TO3              yes
        }

        pre-patch {
#             ui_msg "Patching fontconfig v${fversion} to v2.11.93"
#             if {[catch {eval exec sh -c "\"cd ${worksrcpath} ; ${patch.cmd} -Np1 -i ${filespath}/00-upstream_2.11.93.patch\""} \
#                 result]} {
#                 ui_error "Error applying upstream patches to 2.11.93: $result"
#                 return -code error "Error applying upstream patches to 2.11.93"
#             }
            if {${PY2TO3}} {
                catch {eval exec sh -c "\"cd ${worksrcpath}/fc-blanks ; ${prefix}/bin/2to3-${PYVERSION} -w fc-blanks.py\""} result
                ui_debug "Converting fc-blanks.py to Python ${PYVERSION}: $result"
            }
        }
        foreach f ${INFPATCHES} {
            patchfiles-append   ${f}.${INFRELEASE}
        }
        pre-configure {
            configure.args-append   --with-templatedir=${prefix}/etc/fonts/conf.avail --with-templateinfdir=${TEMPLINFDIR} PYTHON=${PYTHON}
            delete ${worksrcpath}/conf.d.infinality
            copy ${prefix}/share/fonts/fontconfig-ultimate/${INFRELEASE}/conf.d.infinality ${worksrcpath}
            catch {eval exec sh -c "\"cd ${worksrcpath} ; autoreconf -vfi\""} result
            ui_debug "automake: $result"
        }

        notes-append "Be sure to call fc-presets as root to select one of the provided font configuration presets!"
    }

    livecheck.type              regex
    livecheck.url               [lindex ${master_sites} 0]
    livecheck.regex             ${name}-(\\d+(?:\\.\\d+)*\\.(?:\\d|\[0-8\]\\d))\\.tar
}

# kate: backspace-indents true; indent-pasted-text true; indent-width 4; keep-extra-spaces true; remove-trailing-spaces modified; replace-tabs true; replace-tabs-save true; syntax Tcl/Tk; tab-indents true; tab-width 4;
