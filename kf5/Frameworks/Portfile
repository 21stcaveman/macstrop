# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
set kf5.framework   yes
PortGroup           kf5 1.1

name                KF5-Frameworks
version             ${kf5.version}
description         meta-port for the KF5 Frameworks
long_description    ${description}
maintainers         gmail.com:rjvbertin mk openmaintainer

installs_libs       yes
use_xz              yes
test.run            yes

variant qspXDG description {Configure Qt5's QStandardPaths to return XDG/Linuxy paths for shared locations} {
# The Qt5 QStandardPaths (QSP) patch allows QSP to return XDG/linuxy locations (paths) that are more suitable
# for a shared use of Qt5 in the MacPorts universe than the default values QSP returns that follow Apple's
# sandboxing dogmas. It must however be activated so that individual ports have the choice which "flavour" they
# use. KF5 applications should (probably) by using the XDG/Linuxy flavour unless they are to be built into
# individual, autonomous app bundles that each contain all required dependencies.
# Activation of the QSP patch is done by linking an additional, dedicated Qt component: Qt5::QspXDG .
# The approach philosophy used here is to link that component with all KF5 frameworks and helper applications
# built as part of those frameworks, even if they do not use the QSP class themselves. This redundancy comes
# with an overhead that should be negligible, and serves to lower the maintenance burden (monitoring the
# appearance of QSP usage).
}

if {${os.platform} eq "darwin"} {
    if {[file exists ${qt_cmake_module_dir}/Qt5QspXDG/Qt5QspXDGConfig.cmake]} {
        default_variants \
                    +qspXDG
    } else {
        ui_debug "We appear to be building against a Qt5 port that doesn't have RJVB's QSP patch. Don't fight it, just warn."
        notes-append "You will be running KF5 applications with the stock/native Qt5::QStandardPaths behaviour.\
                     That is not the recommended configuration."
    }
}

if {${subport} eq ${name}} {
    depends_build-append \
                    port:kf5-frameworkintegration
    set kf5.framework \
                    frameworkintegration
    fetch {}
    checksum {}
    extract {}
    build {}
    destroot {
        xinstall -d -m 755 ${destroot}${prefix}/share/doc/kf5-installed-packages
        system "touch ${destroot}${prefix}/share/doc/kf5-installed-packages/${name}"
    }
}

# patch.pre_args      -Np1

if {${os.platform} eq "darwin"} {
    # this should probably become under control of a variant
    set kf5.pythondep \
                    port:python27
} elseif {${os.platform} eq "linux"} {
    # for personal use: don't add a python dependency.
    set kf5.pythondep \
                    bin:python:python27
}

post-patch {
    if {[variant_isset qspXDG]} {
        # patch the find_package(Qt5) command to add the activator of the QSP patch (which selects XDG behaviour).
        # careful with the backslashes: it's a regular expression that must be passed on to sed(1) correctly!
        reinplace "s|\\(find_package(Qt5 \[\^\)\]\*\\))|\\1 QspXDG)|g" ${worksrcpath}/CMakeLists.txt
        reinplace "s|\\(find_package(Qt5 \[\^\)\]\*\\))|\\1 QspXDG)|g" ${worksrcpath}/src/CMakeLists.txt
        reinplace "s|\\(target_link_libraries(KF5\[\^ \$\]\*\\)|\\1 PUBLIC Qt5::QspXDG|g" ${worksrcpath}/src/CMakeLists.txt
    }
}

subport kf5-attica {
    description     Open Collaboration Service client library
    long_description \
                    Attica is a Qt library that implements the Open Collaboration Services API version 1.6 .
    set kf5.framework \
                    attica
    checksums       rmd160  31c8e1deedfcf6465a614690e3c14cfa420edc54 \
                    sha256  94c928b84a82c44c1331a1b4d585e894524c4a023f90e1906eaf5441d955ad3d
    conflicts       attica-qt5
}

subport kf5-karchive {
    description     Reading, creating, and manipulating file archives
    long_description \
                    KArchive provides classes for easy reading, creation and manipulation of \
                    "archive" formats like ZIP and TAR. \
                    It also provides transparent compression and decompression of data, like the \
                    GZip format, via a subclass of QIODevice.
    set kf5.framework \
                    karchive
    checksums       rmd160  2f7c73a9ea1cedd76db61b34a2723e0844e31819 \
                    sha256  d0b5dfaf6a98ad40e499c67ec6788247c285c97564e2840a4faff90de27bb5e8
    if {[variant_isset qspXDG]} {
        patchfiles-append \
                    patch-CMakeLists-add-qt5qspxdg-nomodule.diff
    }
}

subport kf5-kcoreaddons {
    description     Qt addon library with a collection of non-GUI utilities
    long_description \
                    KCoreAddons provides classes built on top of QtCore to perform various tasks \
                    such as manipulating mime types, autosaving files, creating backup files, \
                    generating random sequences, performing text manipulations such as macro \
                    replacement, accessing user information and many more.
    set kf5.framework \
                    kcoreaddons
    checksums       rmd160  f0ab1b42a06fd76f68e2f5cd002cf9adcd425fe0 \
                    sha256  b5dd4db06ed1d7b50047bade34520d433c6f30defd7cbd74929cf5dce95a06ec

    depends_lib-append \
                    port:shared-mime-info
    if {[variant_isset qspXDG]} {
        patchfiles-append \
                    patch-kcoreaddons-add-qspxdg.diff
    }
}

subport kf5-kauth {
    description     Execute actions as privileged user
    long_description \
                    KAuth provides a convenient, system-integrated way to offload actions that need \
                    to be performed as a privileged user (root, for example) to small (hopefully \
                    secure) helper utilities.
    set kf5.framework \
                    kauth
    checksums       rmd160  335bd7b2101131c1778740124b74c4ef7233e6f5 \
                    sha256  e2a91e1a4c40d5547c8963c74a805810b6bc192e3193245f52e855addc7219da
    if {[variant_isset qspXDG]} {
        patchfiles-append \
                    patch-kauth-add-qspxdg.diff
    }
    depends_lib-append \
                    ${kf5.kcoreaddons_dep}
    # on linux, PolkitQt5-1 or PolkitQt-1 is required
    if {${os.platform} eq "linux"} {
        depends_lib-append \
                    port:polkit-qt5
    }
}

subport kf5-kconfig {
    description     Persistent platform-independent application settings.
    long_description \
                    KConfig provides an advanced configuration system. It is made of two parts with the evocative names \
                    KConfigCore and KConfigGui.
    set kf5.framework \
                    kconfig
    checksums       rmd160  2612543f44d795c8705315c6eb06d734a3589acf \
                    sha256  764bc8af55482cf1c88817c85c12a0fdb3fde5726ab0386cbb1b2f5df2256f20
    if {[variant_isset qspXDG]} {
        patchfiles-append \
                    patch-kconfig-add-qspxdg.diff
    }
}

subport kf5-kcodecs {
    description     String encoding library
    long_description \
                    KCodecs provide a collection of methods to manipulate strings using various \
                    encodings. It can automatically determine the charset of a string, translate XML entities, \
                    validate email addresses, and find encodings by name in a more tolerant way than QTextCodec \
                    (useful e.g. for data coming from the Internet).
    set kf5.framework \
                    kcodecs
    checksums       rmd160  77e468e22a3c412d9bf0f322a6f1adf8df23cb41 \
                    sha256  f71c51f064fdfde2b6eeb898aaf1f651c407e91844306359a7c07dbafadae8cf
    if {[variant_isset qspXDG]} {
        patchfiles-append \
                    patch-CMakeLists-add-qt5qspxdg-nomodule.diff
    }
}

subport kf5-ki18n {
    description     KDE Gettext-based UI text internationalisation
    long_description \
        KI18n provides functionality for internationalising user interface text \
        in applications, based on the GNU Gettext translation system. \
        It wraps the standard Gettext functionality, so that the programmers \
        and translators can use the familiar Gettext tools and workflows. \
        KI18n provides additional functionality as well, for both programmers \
        and translators, which can help to achieve a higher overall quality \
        of source and translated text. This includes argument capturing, \
        customisable markup, and translation scripting.
    set kf5.framework \
                    ki18n
    checksums       rmd160  7b112a3842fcdc0d3ba4f2389a9af8a070c60dca \
                    sha256  ade17464f9d794fb732aa77de3060a8fcbf4b6c91a750be5d47e49adc9b6c763
#   The Qt5::QspXDG activator module shouldn't be necessary for plugins
#     if {[variant_isset qspXDG]} {
#         patchfiles-append \
#                     patch-ki18n-add-qspxdg.diff
#     }
}

subport kf5-kdoctools {
    description     Create documentation from DocBook
    long_description \
                    Provides tools to generate documentation in various format from DocBook files.
    set kf5.framework \
                    kdoctools
    checksums       rmd160  90c407a475c8b72e29e61ef1a98fa8e7793730ca \
                    sha256  6ac31e6349420cd94a5353c8f608700e2c8adb7f29e57f3eeb9118aaf619916d
    depends_build-append \
                    ${kf5.ki18n_dep} \
                    ${kf5.pythondep}
    depends_lib-append \
                    ${kf5.karchive_dep} \
                    port:libxslt \
                    port:docbook-xml \
                    port:docbook-xsl \
                    port:p5-uri \
                    port:gettext
    if {[variant_isset qspXDG]} {
        patchfiles-append \
                    patch-kdoctools-add-qspxdg.diff
    }
# this patch is unnecessary if the kdelibs4 headers are moved out of the ${prefix}/include root
#     if {${os.platform} eq "darwin"} {
#         # workaround what appears to be a bug in the kdoctools buildsystem that
#         # causes it to pick up KDE4 headerfiles when they're present:
#         patchfiles-append \
#                     patch-kdoctools-xslt_kde.cpp.diff
#     }
    configure.args-append \
                        -DDOCBOOKXSL_DIR=${prefix}/share/xsl/docbook-xsl \
                        -DLIBXML2_INCLUDE_DIR=${prefix}/include/libxml2 \
                        -DLIBXML2_LIBRARIES=${prefix}/lib/libxml2.${kf5.libs_ext} \
                        -DLIBXML2_XMLLINT_EXECUTABLE=${prefix}/bin/xmllint \
                        -DLIBXSLT_INCLUDE_DIR=${prefix}/include \
                        -DLIBXSLT_LIBRARIES=${prefix}/lib/libxslt.${kf5.libs_ext}
}

subport kf5-kguiaddons {
    description     Utilities for graphical user interfaces
    long_description \
                    The KDE GUI addons provide utilities for graphical user interfaces in the areas \
                    of colours, fonts, text, images, keyboard input.
    set kf5.framework \
                    kguiaddons
    checksums       rmd160  574176126098992f49f11cb11b4224dacd9acc46 \
                    sha256  081b18c79c37f9e050c87264563392625a7eb0b527fb27c6840f443382b6cc5d
    if {[variant_isset qspXDG]} {
        # this is a probable case of currently unneeded QSP patch activation
        patchfiles-append \
                    patch-kguiaddons-add-qspxdg.diff
    }
}

subport kf5-kwidgetsaddons {
    description     A large set of desktop widgets
    long_description \
                    This repository contains add-on widgets and classes for applications \
                    that use the Qt Widgets module. If you are porting applications from \
                    KDE Platform 4 "kdeui" library, you will find many of its classes here. \
                    Provided are action classes that can be added to toolbars or menus, \
                    a wide range of widgets for selecting characters, fonts, colours, \
                    actions, dates and times, or MIME types, as well as platform-aware \
                    dialogs for configuration pages, message boxes, and password requests. \
                    Further widgets and classes can be found in other KDE frameworks.
    set kf5.framework \
                    kwidgetsaddons
    checksums       rmd160  05cc16185b9d3d7f9b5c2bb439315823299bf0d4 \
                    sha256  c3e0fed862a3053481a526f923e79cdef890cec93105fe95080e7cd78ad36fd9
}

subport kf5-kconfigwidgets {
    description     Widgets for configuration dialogs
    long_description \
                    KConfigWidgets provides easy-to-use classes to create configuration dialogs, as \
                    well as a set of widgets which uses KConfig to store their settings.
    set kf5.framework \
                    kconfigwidgets
    checksums       rmd160  3053310c30d9342008277e97264932ac917b9ed7 \
                    sha256  43664b4e2b4175401dba9da379c0cd98d86627e68cb87e7d31e838ff5c3c783e
    depends_build-append \
                    port:gettext \
                    ${kf5.pythondep}
    depends_lib-append \
                    ${kf5.kwidgetsaddons_dep} \
                    ${kf5.kguiaddons_dep} \
                    ${kf5.kconfig_dep} \
                    ${kf5.kauth_dep} \
                    ${kf5.ki18n_dep} \
                    ${kf5.kcoreaddons_dep} \
                    ${kf5.kdoctools_dep} \
                    ${kf5.kcodecs_dep}
}

subport kf5-kitemviews {
    description     Set of item views extending the Qt model-view framework
    long_description \
                    KItemViews includes a set of views, which can be used with item models. It \
                    includes views for categorising lists and to add search filters to flat and \
                    hierarchical lists.
    set kf5.framework \
                    kitemviews
    checksums       rmd160  37e85025ac6e6a3822080a58d52eee82012ad160 \
                    sha256  d1637a8ccbf1bf349e38682b0615785ab3610807328acc7ed47c73e0e8e92284
}

subport kf5-kiconthemes {
    description     Icon GUI utilities
    long_description \
                    This library contains classes to improve the handling of icons \
                    in applications using the KDE Frameworks.
    set kf5.framework \
                    kiconthemes
    checksums       rmd160  5f7dee9359c58a76c7a66571db8109d914164052 \
                    sha256  e2fdf07e04e9fd06a4515677a5bcaf31bfc309d0772578e5ff915039e28c6929
    depends_build-append \
                    port:gettext \
                    ${kf5.pythondep}
    depends_lib-append \
                    ${kf5.ki18n_dep} \
                    ${kf5.kconfigwidgets_dep} \
                    ${kf5.kwidgetsaddons_dep} \
                    ${kf5.kitemviews_dep}
    if {[variant_isset qspXDG]} {
        patchfiles-append \
                    patch-kiconthemes-add-qspxdg.diff
    }
}

subport kf5-kwindowsystem {
    description     Access to the windowing system
    long_description \
                    Convenience access to certain properties and features of the windowing system. \
                    KWindowSystem provides information about the windowing system and allows interaction with \
                    the windowing system. It provides a high level API which is windowing system independent and \
                    has platform specific implementations. This API is inspired by X11 and thus not all functionality \
                    is available on all windowing systems. On Mac OS X, X11 support is not included though that \
                    would be possible theoretically.
    set kf5.framework \
                    kwindowsystem
    checksums       rmd160  494db63845f868823346e6ab79ad53ab48c87ea4 \
                    sha256  1db9fcc1a109556cc41896b17427a031bfa7bdaf6bab36b415f348e3d75317f5
}

subport kf5-kcrash {
    description     Graceful handling of application crashes
    long_description \
                    KCrash provides support for intercepting and handling application crashes.
    set kf5.framework \
                    kcrash
    checksums       rmd160  d2dbbd564a9b2a42bba99e209074102b8c67c579 \
                    sha256  7eac0e5ed260bf60c674a82981aaac81feea9ca5b6bb2a34256b95845ee56198
    depends_lib-append \
                    ${kf5.kcoreaddons_dep} \
                    ${kf5.kwindowsystem_dep}
    if {${os.platform} eq "darwin"} {
        patchfiles-append \
                    patch-kcrash-dont-closeAllFDs.diff
    }
}

homepage            http://projects.kde.org/projects/${kf5.virtualPath}/${kf5.framework}
master_sites        http://download.kde.org/stable/${kf5.folder}
distname            ${kf5.framework}-${version}

livecheck.type      regex
livecheck.url       http://download.kde.org/stable/frameworks/${kf5.branch}
livecheck.regex     (5+(\\.\\d+)+)

# kate: backspace-indents true; indent-pasted-text true; indent-width 4; keep-extra-spaces true; remove-trailing-spaces modified; replace-tabs true; replace-tabs-save true; syntax Tcl/Tk; tab-indents true; tab-width 4;
