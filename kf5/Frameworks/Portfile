# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
set kf5.framework   yes
PortGroup           kf5 1.1

name                KF5-Frameworks
version             ${kf5.version}
description         meta-port for the KF5 Frameworks
long_description    ${description}
maintainers         gmail.com:rjvbertin mk openmaintainer

installs_libs       yes
use_xz              yes

variant qspXDG description {Configure Qt5's QStandardPaths to return XDG/Linuxy paths for shared locations} {
# The Qt5 QStandardPaths (QSP) patch allows QSP to return XDG/linuxy locations (paths) that are more suitable
# for a shared use of Qt5 in the MacPorts universe than the default values QSP returns that follow Apple's
# sandboxing dogmas. It must however be activated so that individual ports have the choice which "flavour" they
# use. KF5 applications should (probably) by using the XDG/Linuxy flavour unless they are to be built into
# individual, autonomous app bundles that each contain all required dependencies.
# Activation of the QSP patch is done by linking an additional, dedicated Qt component: Qt5::QspXDG .
# The approach philosophy used here is to link that component with all KF5 frameworks and helper applications
# built as part of those frameworks, even if they do not use the QSP class themselves. This redundancy comes
# with an overhead that should be negligible, and serves to lower the maintenance burden (monitoring the
# appearance of QSP usage).
}

if {${os.platform} eq "darwin"} {
    default_variants \
                    +qspXDG
}

if {${subport} eq ${name}} {
    depends_build-append \
                    port:kf5-frameworkintegration
    set kf5.framework \
                    frameworkintegration
    fetch {}
    checksum {}
    extract {}
    build {}
    destroot {
        xinstall -d -m 755 ${destroot}${prefix}/share/doc/kf5-installed-packages
        system "touch ${destroot}${prefix}/share/doc/kf5-installed-packages/${name}"
    }
}

# patch.pre_args      -Np1

post-patch {
    if {[variant_isset qspXDG]} {
        # patch the find_package(Qt5) command to add the activator of the QSP patch (which selects XDG behaviour).
        # careful with the backslashes: it's a regular expression that must be passed on to sed(1) correctly!
        reinplace "s|\\(find_package(Qt5 \[\^\)\]\*\\))|\\1 QspXDG)|g" ${worksrcpath}/CMakeLists.txt
        reinplace "s|\\(find_package(Qt5 \[\^\)\]\*\\))|\\1 QspXDG)|g" ${worksrcpath}/src/CMakeLists.txt
        reinplace "s|\\(target_link_libraries(KF5\[\^ \$\]\*\\)|\\1 PUBLIC Qt5::QspXDG|g" ${worksrcpath}/src/CMakeLists.txt
    }
}

subport kf5-attica {
    description     Open Collaboration Service client library
    long_description \
                    Attica is a Qt library that implements the Open Collaboration Services API version 1.6 .
    set kf5.framework \
                    attica
    checksums       rmd160  31c8e1deedfcf6465a614690e3c14cfa420edc54 \
                    sha256  94c928b84a82c44c1331a1b4d585e894524c4a023f90e1906eaf5441d955ad3d
    conflicts       attica-qt5
}

subport kf5-karchive {
    description     Reading, creating, and manipulating file archives
    long_description \
                    KArchive provides classes for easy reading, creation and manipulation of \
                    "archive" formats like ZIP and TAR. \
                    It also provides transparent compression and decompression of data, like the \
                    GZip format, via a subclass of QIODevice.
    set kf5.framework \
                    karchive
    checksums       rmd160  2f7c73a9ea1cedd76db61b34a2723e0844e31819 \
                    sha256  d0b5dfaf6a98ad40e499c67ec6788247c285c97564e2840a4faff90de27bb5e8
    if {[variant_isset qspXDG]} {
        patchfiles-append \
                    patch-CMakeLists-add-qt5qspxdg-nomodule.diff
    }
}

subport kf5-kcoreaddons {
    description     Qt addon library with a collection of non-GUI utilities
    long_description \
                    KCoreAddons provides classes built on top of QtCore to perform various tasks \
                    such as manipulating mime types, autosaving files, creating backup files, \
                    generating random sequences, performing text manipulations such as macro \
                    replacement, accessing user information and many more.
    set kf5.framework \
                    kcoreaddons
    checksums       rmd160  f0ab1b42a06fd76f68e2f5cd002cf9adcd425fe0 \
                    sha256  b5dd4db06ed1d7b50047bade34520d433c6f30defd7cbd74929cf5dce95a06ec

    depends_lib-append \
                    port:shared-mime-info
    if {[variant_isset qspXDG]} {
        patchfiles-append \
                    patch-kcoreaddons-add-qspxdg.diff
    }
}

subport kf5-kauth {
    description     Execute actions as privileged user
    long_description \
                    KAuth provides a convenient, system-integrated way to offload actions that need \
                    to be performed as a privileged user (root, for example) to small (hopefully \
                    secure) helper utilities.
    set kf5.framework \
                    kauth
    checksums       rmd160  335bd7b2101131c1778740124b74c4ef7233e6f5 \
                    sha256  e2a91e1a4c40d5547c8963c74a805810b6bc192e3193245f52e855addc7219da
    if {[variant_isset qspXDG]} {
        patchfiles-append \
                    patch-kauth-add-qspxdg.diff
    }
    depends_lib-append \
                    ${kf5.kcoreaddons_dep}
    # on linux, PolkitQt5-1 or PolkitQt-1 is required
    if {${os.platform} eq "linux"} {
        depends_lib-append \
                    port:polkit-qt5
    }
}

subport kf5-kconfig {
    description     Persistent platform-independent application settings.
    long_description \
                    KConfig provides an advanced configuration system. It is made of two parts with the evocative names \
                    KConfigCore and KConfigGui.
    set kf5.framework \
                    kconfig
    checksums       rmd160  2612543f44d795c8705315c6eb06d734a3589acf \
                    sha256  764bc8af55482cf1c88817c85c12a0fdb3fde5726ab0386cbb1b2f5df2256f20
    if {[variant_isset qspXDG]} {
        patchfiles-append \
                    patch-kconfig-add-qspxdg.diff
    }
}

subport kf5-kcodecs {
    description     String encoding library
    long_description \
                    KCodecs provide a collection of methods to manipulate strings using various \
                    encodings. It can automatically determine the charset of a string, translate XML entities, \
                    validate email addresses, and find encodings by name in a more tolerant way than QTextCodec \
                    (useful e.g. for data coming from the Internet).
    set kf5.framework \
                    kcodecs
    checksums       rmd160  77e468e22a3c412d9bf0f322a6f1adf8df23cb41 \
                    sha256  f71c51f064fdfde2b6eeb898aaf1f651c407e91844306359a7c07dbafadae8cf
    if {[variant_isset qspXDG]} {
        patchfiles-append \
                    patch-CMakeLists-add-qt5qspxdg-nomodule.diff
    }
}

subport kf5-ki18n {
    description     KDE Gettext-based UI text internationalisation
    long_description \
        KI18n provides functionality for internationalising user interface text \
        in applications, based on the GNU Gettext translation system. \
        It wraps the standard Gettext functionality, so that the programmers \
        and translators can use the familiar Gettext tools and workflows. \
        KI18n provides additional functionality as well, for both programmers \
        and translators, which can help to achieve a higher overall quality \
        of source and translated text. This includes argument capturing, \
        customisable markup, and translation scripting.
    set kf5.framework \
                    ki18n
    checksums       rmd160  7b112a3842fcdc0d3ba4f2389a9af8a070c60dca \
                    sha256  ade17464f9d794fb732aa77de3060a8fcbf4b6c91a750be5d47e49adc9b6c763
#   The Qt5::QspXDG activator module shouldn't be necessary for plugins
#     if {[variant_isset qspXDG]} {
#         patchfiles-append \
#                     patch-ki18n-add-qspxdg.diff
#     }
}

homepage            http://projects.kde.org/projects/${kf5.virtualPath}/${kf5.framework}
master_sites        http://download.kde.org/stable/${kf5.folder}
distname            ${kf5.framework}-${version}

livecheck.type      regex
livecheck.url       http://download.kde.org/stable/frameworks/${kf5.branch}
livecheck.regex     (5+(\\.\\d+)+)

# kate: backspace-indents true; indent-pasted-text true; indent-width 4; keep-extra-spaces true; remove-trailing-spaces modified; replace-tabs true; replace-tabs-save true; syntax Tcl/Tk; tab-indents true; tab-width 4;
