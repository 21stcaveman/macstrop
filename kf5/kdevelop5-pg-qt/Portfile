# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 117140 2014-02-17 15:18:38Z nicos@macports.org $

PortSystem          1.0
PortGroup           muniversal 1.0
PortGroup           compiler_blacklist_versions 1.0
PortGroup           conflicts_build 1.0

set kf5.project     kdevelop-pg-qt
set kf5.virtualPath applications
set kf5.category    development
PortGroup           kf5 1.1

description         the parser-generator from KDevplatform5.
long_description    the parser-generator from KDevplatform5. It is used for some of \
                    KDevelop's languagesupport-plugins (e.g. for QMake).
homepage            https://techbase.kde.org/Development/KDevelop-PG-Qt_Introduction

platforms           darwin
license             GPL-2+

installs_libs       no

subport ${name}-devel {
    description     ${description} This port follows git/master.
    long_description \
                    ${long_description} This port follows git/master.
}

pre-fetch {
    if {[file exists ${prefix}/include/kdevplatform/kdevplatformversion.h]} {
        # this file is called kdevplatform_version.h in kdevplatform KF5
        ui_error "You have an incompatible KDE4 version of kdevplatform installed & active"
        return -code error "Incompatible KDE4 version installed & active"
    }
}

if {${subport} eq "${name}-devel"} {
    conflicts       ${name}
    fetch.type      git
    if {[file exists ${filespath}/${name}-git/.git]} {
        git.url     ${filespath}/${name}-git
    } else {
        git.url     git://anongit.kde.org/kdevelop-pg-qt
    }
    # v1.90.91-8-g6252395
    git.branch      6252395433d8277b961c0629f69af917bbc9533d
    version         1.90.91.8
} else {
    conflicts       ${name}-devel
    description     ${description} This port doesn't have a release version yet.
    long_description \
                    ${long_description} This port doesn't have a release version yet.
    version         2.0.0
    use_xz          yes
    pre-fetch {
        ui_error "This port doesn't have a release version yet."
        return -code error "This port doesn't have a release version yet."
    }
}
conflicts           kdevelop-pg-qt

worksrcdir          ${name}-5
distname            ${name}-5

patch.pre_args      -Np1

# build kdev-pg-qt as a regular executable, and call it kdev-pg-qt5
patchfiles-append   patch-nongui-renamed-executable.diff

compiler.blacklist-append {clang < 500}
compiler.blacklist-append macports-clang-3.1 macports-clang-3.0 macports-clang-3.2 macports-clang-3.3 macports-clang-3.4
compiler.blacklist-append macports-llvm-gcc-4.2 llvm-gcc-4.2
compiler.blacklist-append gcc-4.2 apple-gcc-4.2 gcc-4.0

#Binaries do not link to openssl
license_noconflict  openssl

variant apidocs description {Generate the API documentation} {
    default_variants +docs
    set kf5.allow_docs_generation yes
}
if {![variant_isset apidocs]} {
    unset kf5.allow_docs_generation
}

#Using c++0x for Lion and higher in case of clang 64-bit
if {${configure.compiler} eq "clang" && ${os.platform} eq "darwin" && ${os.major} >= 11} {
    lappend merger_configure_args(x86_64)   -DHAVE_UNORDERED_MAP=1
    if {${build_arch} eq "x86_64" && ![variant_isset universal]} {
        configure.args-append               -DHAVE_UNORDERED_MAP=1
    }
}

platform darwin {
    variant kde4compat description {allow installation alongside KDE4's port:kdevelop} {}
    post-destroot {
        if {[variant_isset kde4compat]} {
#             file delete -force ${destroot}${prefix}/share/icons
        }
    }
}