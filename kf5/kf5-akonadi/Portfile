# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           compiler_blacklist_versions 1.0

set kf5.project     [string map [list "kf5-" ""] ${subport}]
set kf5.virtualPath applications
PortGroup           kf5 1.1
set kf5.category    office
kf5.use_latest      applications

maintainers         gmail.com:rjvbertin mk openmaintainer

installs_libs       yes

kf5.allow_apidocs_generation no
variant kde4compat description {build for installation on a system that uses KDE4's Akonadi} {}
# this is currently the default!!
default_variants    +kde4compat

patch.pre_args      -Ntp1

platform darwin {
    compiler.blacklist *gcc* {clang < 602} macports-clang-3.3 macports-clang-3.4 macports-clang-3.5
    foreach clv {3.6 3.7 3.8 3.9 4.0} {
        if {[file exists ${prefix}/bin/clang-mp-${clv}]} {
            compiler.whitelist-prepend macports-clang-${clv}
        }
        compiler.fallback-prepend macports-clang-${clv}
    }
}

subport kf5-akonadi {
    description     Akonadi Server and supporting libraries.
    long_description \
                    Akonadi is an extensible cross-desktop storage service \
                    for PIM data and metadata providing concurrent read, write, and query access. \
                    Please read the port notes!
    homepage        https://community.kde.org/KDE_PIM/Akonadi
    checksums       rmd160  9a3372c8de4a87e3aa4e37ba03925e72b887a3d1 \
                    sha256  54098782c6de7db9f3e3a30e26f56d71d8ffd8e8f9b42b9b393b1db30a035607

    patchfiles-append \
                    patch-akonadi-cmakefiles.diff \
                    patch-mp-paths.diff
    post-patch {
        reinplace -W ${worksrcpath} "s|@PREFIX@|${prefix}|g" \
                    src/private/xdgbasedirs.cpp \
                    src/server/storage/dbconfigmysql.cpp \
                    src/server/storage/dbconfigpostgresql.cpp
    }

    variant mariadb55 \
        conflicts sqlite mysql51 mysql55 mysql56 percona55 \
        description {build with mariadb port} {

        platform darwin {
            depends_run-append \
                    port:mariadb-server
            configure.args-append \
                    -DMYSQLD_EXECUTABLE=${prefix}/lib/mariadb/bin/mysqld
        }
        configure.args-append \
                    -DDATABASE_BACKEND=MYSQL
    }
    default_variants +mariadb55

    depends_lib-append \
                    port:boost \
                    port:shared-mime-info \
                    port:libxml2 \
                    port:libxslt

    kf5.depends_qt5_components \
                    qttools

    kf5.depends_frameworks \
                    kcompletion kconfig kconfigwidgets kcoreaddons \
                    kcrash kdbusaddons kdesignerplugin ki18n \
                    kiconthemes kio kitemmodels kitemviews \
                    knotifications kwidgetsaddons kwindowsystem kxmlgui

    kf5.kde4compat {
        post-destroot {
            file delete -force ${destroot}${prefix}/bin \
                    ${destroot}${prefix}/share/akonadi \
                    ${destroot}${prefix}/share/config.kcfg \
                    ${destroot}${prefix}/share/dbus-1 \
                    ${destroot}${prefix}/share/icons \
                    ${destroot}${prefix}/share/mime
        }
        notes-append "This variant of the port is provided solely for its libraries."
    } else {
        notes-append "Building kf5-akonadi without the +kde4compat variant isn't currently supported nor tested.
This WILL cause issues with KDE4's Akonadi if you also have that installed and use it."
    }

    post-destroot {
    #     kf5.add_app_wrapper kruler5 kruler
    }

}
