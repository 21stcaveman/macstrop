# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$
# Copyright (c) 2015, 2016 R.J.V. Bertin

PortSystem          1.0

set kf5.project     calligra
set kf5.virtualPath applications
set kf5.category    office
PortGroup           kf5 1.1
PortGroup           active_variants 1.1

maintainers         gmail.com:rjvbertin mk openmaintainer
name                kf5-calligra-suite
version             3.0.0.1
distname            ${kf5.project}-${version}

description         KDE Calligra Suite
long_description    Calligra Suite is a set of applications written to help you to accomplish your work. \
                    It includes efficient and capable office components: Words for text processing, \
                    Sheets for computations, Stage for presentations, Plan for planning, Flow for flowcharts \
                    and Karbon for vector graphics. Each of these components can be selected by the named variant. \
                    Former components Krita and Kexi are now separate projects and ports.
homepage            http://www.calligra.org
conflicts           calligra

master_sites        http://download.kde.org/stable/${kf5.project}/${version}
checksums           rmd160  d58da6ab46a43ce3533f18fd78cfb699da54d154 \
                    sha256  dedc51efc42f7dda37514d450cb772d9db37a658e0abbcf0f513712a04c1f011

kf5.allow_apidocs_generation no
patch.pre_args      -Np1

# shared dependencies
platform darwin {
    depends_lib-append \
                    port:freetype \
                    port:fontconfig \
                    port:lcms2 \
                    port:zlib \
                    port:gsl \
                    port:libvisio-0.1
}
depends_lib-append \
                    port:boost \
                    port:eigen3 \
                    port:Vc \
                    port:shared-mime-info \
                    port:poppler-qt5 \
                    port:libgit2 \
                    port:libiconv \
                    port:phonon-qt5 \
                    port:qca-qt5 \
                    port:librevenge \
                    port:libodfgen \
                    port:libwpd-0.10 \
                    port:libwpg-0.3 \
                    port:libwps \
                    port:libetonyek \
                    port:openexr \
                    port:kf5-kcalcore \
                    path:${kf5.libs_dir}/libOkular5Core.${kf5::libs_ext}:kf5-okular \
                    port:kf5-kpropertywidgets \
                    port:kf5-kreport

kf5.depends_qt5_components \
                    qtdeclarative qtwebkit
kf5.depends_frameworks \
                    kactivities karchive kcmutils kcodecs kcompletion \
                    kconfig kconfigwidgets kcoreaddons kcrash kdbusaddons \
                    kguiaddons khtml ki18n kiconthemes kitemviews \
                    kdelibs4support kio knotifications knotifyconfig \
                    kross kparts kpty kservice ktexteditor ktextwidgets \
                    kwallet kwidgetsaddons kwindowsystem \
                    kxmlgui sonnet threadweaver

variant maps description {include support for maps using port:kf5-marble} {}
if {[variant_isset maps]} {
    depends_lib-append \
                    port:kf5-marble
} else {
    configure.args-append \
                    -DWITH_Marble=OFF
}

patchfiles-append \
                    patch-general-cmakelist.diff \
                    patch-nongui-converter.diff \
                    patch-app-icons.diff \
                    patch-build-for-macports.diff

# # given the size of the source directory we'll try our best to share as much as possible
# # between subports.
# # SADLY this messes up `port work foo` :-/
# # set parentworkpath  [join [lrange [split ${workpath} "/"] 0 end-2] "/"]
# # set workpath        "${parentworkpath}/${kf5.project}/work"
# # set worksrcpath     "${workpath}/${distname}"
# proc set_work_paths {dir} {
#     global workpath worksrcdir worksrcpath configure.dir build.dir configure.post_args
#     cmake.source_dir    ${worksrcpath}/${dir}
#     cmake.build_dir     ${workpath}/build-${dir}
#     ui_info "worksrcdir=${worksrcdir}"
#     ui_info "worksrcpath=${worksrcpath}"
#     ui_info "configure.dir=${configure.dir}"
#     ui_info "build.dir=${build.dir}"
#     ui_info "configure.post_args=${configure.post_args}"
# }

set selected_components 0
options productset
default productset  {"LIB_KOVECTORIMAGE \
                    LIB_CALLIGRA \
                    LIB_KOMAIN \
                    LIB_KOODFREADER \
                    LIB_MSO \
                    LIB_KOMSOOXML \
                    FEATURE_SCRIPTING \
                    PLUGIN_TEXTSHAPE \
                    APP_CONVERTER \
                    FILEMANAGER \
                    APP_DEVTOOLS"}

configure.args-append \
                    -DAPPLE_STANDALONE_BUNDLE=OFF \
                    -DWITH_KGantt=OFF -DWITH_KChart=OFF \
                    -DRELEASE_BUILD=ON

if {[variant_isset docs]} {
    patchfiles-append \
                    patch-force-docs-build.diff
    post-configure {
        ui_info "You can ignore the CMake message about not building the documentation"
    }
    productset-append \
                    DOC
}

pre-configure {
    if {${selected_components} <= 0 && ${subport} eq "${name}"} {
        ui_error "You need to select at least 1 product variant!"
        return -code error "No variants selected"
    }
    # append the final PRODUCTSET definition
    configure.args-append \
                    -DPRODUCTSET="${productset}"
}

variant karbon description {build Karbon, Calligra's vector graphics application} {}
variant words description {build Words, Calligra's word processing application} {}

if {[variant_isset karbon]} {
    productset-append \
                    KARBON
    platform darwin {
        depends_run-append \
                    port:pstoedit
    }
    set selected_components [expr ${selected_components} + 1]
    post-destroot {
        kf5.add_app_wrapper karbon5 karbon
    }
}

if {[variant_isset words]} {
    productset-append \
                    WORDS
    set selected_components [expr ${selected_components} + 1]
    patchfiles-append \
                    patch-wordsfilters-odf.diff
    post-destroot {
        kf5.add_app_wrapper calligrawords5 calligrawords
    }
}

subport kf5-karbon {
    description     Calligra's vector graphics application
    long_description \
                    Karbon is Calligra's vector graphics application.
    installs_libs   no
    supported_archs noarch
    default_variants +karbon
    depends_lib-append \
                    port:kf5-calligra-suite
    require_active_variants kf5-calligra-suite karbon
    productset-append \
                    KARBON
    distfiles
    fetch {}
    checksum {}
    extract {}
    patchfiles
    use_configure   no
    build {}
    destroot {
        xinstall -d -m 755 ${destroot}${prefix}/share/doc/kf5-installed-meta-ports
        system "touch ${destroot}${prefix}/share/doc/kf5-installed-meta-ports/${subport}"
    }
}

subport kf5-calligrawords {
    description     Calligra's word processing application
    long_description \
                    Words is Calligra's word processing application.
    installs_libs   no
    supported_archs noarch
    default_variants +words
    depends_lib-append \
                    port:kf5-calligra-suite
    require_active_variants kf5-calligra-suite words
    productset-append \
                    WORDS
    distfiles
    fetch {}
    checksum {}
    extract {}
    patchfiles
    use_configure   no
    build {}
    destroot {
        xinstall -d -m 755 ${destroot}${prefix}/share/doc/kf5-installed-meta-ports
        system "touch ${destroot}${prefix}/share/doc/kf5-installed-meta-ports/${subport}"
    }
}

livecheck.url       http://download.kde.org/stable
livecheck.regex     calligra\\-(\\d+\\.\\d+\\.\\d)
