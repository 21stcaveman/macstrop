# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

set kf5.project     konsole
set kf5.virtualPath applications
set kf5.category    system
PortGroup           kf5 1.1
kf5.use_latest		applications

maintainers         gmail.com:rjvbertin mk openmaintainer

description         Konsole is the terminal emulator for the K Desktop Environment.
long_description    Konsole is an X terminal emulator for the KDE platform, allowing users \
                    to have a convenient way to use the command line. Aside from providing \
                    a way to use a powerful shell, Konsole also offers features that make \
                    it easier or more pleasurable to work from the command line, such as \
                    profile management, scrollback, and colour schemes, including \
                    translucency for effects.

homepage            http://userbase.kde.org/Konsole

checksums           rmd160  c007d05b1cf45f18bc17030a359656b51e755438 \
                    sha256  cfd5628b68e14db7b6228099b9e45eb35f8a04bfea05bf9c61bae0bf2803c8ce

#Binaries do not link directly to openssl, nor use the ssl backend of kdelibs4,
#nor links to libkimap or libmailtransport from kdepimlibs4
license_noconflict  openssl

depends_build-append \
                    ${kf5.oxygen-icons_dep}
kf5.depends_frameworks \
                    kcoreaddons kdoctools kguiaddons \
                    ki18n kiconthemes kinit kdelibs4support \
                    kio knotifications knotifyconfig \
                    kparts kpty kservice ktextwidgets \
                    kwidgetsaddons kwindowsystem kxmlgui

# submit upstream
patchfiles-append   patch-key-shortcuts.diff

patchfiles-append   patch-really-no-x11.diff

platform darwin {
    patchfiles-append \
                    patch-add-icon.diff
    # submit upstream
    # prevent errors like
    # void QCocoaMenu::insertNative(QCocoaMenuItem *, QCocoaMenuItem *) Menu item "Set &Encoding" is already in menu "View" , remove it from the other menu first before inserting into "Untitled"
    # virtual void QCocoaMenu::removeMenuItem(QPlatformMenuItem *) Item "&Switch Profile" to remove does not belong to this menu "Untitled"
    # and the associated crash-on-exit.
    patchfiles-append \
                    patch-prune-contextmenu.diff
    variant nativemenubar description {use the Mac's native/toplevel menubar instead of per-window menubars} {
        patchfiles-append \
                    patch-use-native-menu.diff
    }
    post-patch {
        if {![file exists ${build.dir}/src/icons]} {
            xinstall -m 755 -d ${build.dir}/src/icons
            kf5.link_icons ${prefix}/share/icons/oxygen apps utilities-terminal.png ${build.dir}/src/icons
        }
        if {[variant_isset kde4compat]} {
            # attempt to make the handbook available under "konsole5" (doesn't appear to work)
            reinplace "s|kappname \"\&konsole\;\"|kappname \"\\\&konsole5\;\"|g" ${worksrcpath}/doc/manual/index.docbook
            reinplace "s|book id=\"konsole\"|book id=\"konsole5\"|g" ${worksrcpath}/doc/manual/index.docbook
            reinplace "s|Konsole|Konsole5|g" ${worksrcpath}/doc/manual/index.docbook
        }
    }

    variant kde4compat description {allow installation alongside KDE4's port:konsole} {}
    post-destroot {
        if {[variant_isset kde4compat]} {
            file rename ${destroot}${prefix}/bin/konsoleprofile ${destroot}${prefix}/bin/konsoleprofile5
            file rename ${destroot}${prefix}/share/konsole ${destroot}${prefix}/share/konsole5
            file rename ${destroot}${prefix}/share/doc/HTML/en/konsole ${destroot}${prefix}/share/doc/HTML/en/konsole5
        }
        ln -s ${kf5.applications_dir}/konsole.app/Contents/MacOS/konsole ${destroot}${prefix}/bin/konsole5
    }
}
