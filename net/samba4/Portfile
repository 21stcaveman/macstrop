PortSystem      1.0
PortGroup       code-sign 1.0
PortGroup       compress_workdir 1.0
PortGroup       conflicts_build 1.0

name            samba4
version         4.8.9
categories      net
platforms       darwin
maintainers     openmaintainer
license         GPL-3
description     SMB/CIFS server and client
long_description \
                Samba is the standard Windows interoperability suite of programs for Linux and Unix. \
                This is version ${version} which is API compatible with the version from port:samba3.

homepage        http://www.samba.org/
master_sites    https://download.samba.org/pub/samba/stable
distname        samba-${version}
checksums       rmd160  24b661c5a2ead293ce4003b71072d321f34ece69 \
                sha256  ad2acf6bed436c125314a054f0589308eb664ac3d96cfb02d05e654a44e09c80
#                 size    17750151

depends_build   port:python27

depends_lib     port:gnutls \
                port:readline \
                port:libarchive \
                port:openldap \
                port:libiconv \
                port:zlib \
                port:gettext \
                port:gpgme \
                port:py27-pygpgme
platform darwin {
    depends_lib-append \
                port:popt \
                port:jansson
}
## Extra host packages installed on Linux:
#   faketime gir1.2-tracker-0.16 libexempi3 libfaketime libiptcdata0
#   libjansson-dev libjansson4 libldb-dev libparse-yapp-perl libtalloc-dev
#   libtevent-dev libtracker-extract-0.16-0 libtracker-miner-0.16-0
#   libtracker-sparql-0.16-dev python-extras python-fixtures python-ldb-dev
#   python-mimeparse python-talloc-dev python-testtools


patch.pre_args  -Np1
platform darwin {
    patchfiles-append \
                patch-nss-test.diff \
                patch-max_grp.diff \
                patch-no-attributes_h.diff \
                patch-xml-catalog.diff

    post-patch {
        reinplace -W ${worksrcpath} "s|@PREFIX@|${prefix}|g" \
                release-scripts/build-docs \
                release-scripts/build-htmlman-git \
                release-scripts/build-htmlman-nogit \
                release-scripts/build-manpages-git \
                release-scripts/build-manpages-nogit
    }
    configure.ldflags-append -v
}

# inspired from Ubuntu's packaging (debian/rules):
configure.cmd   ${prefix}/bin/python2.7 ./buildtools/bin/waf configure
build.cmd       ${prefix}/bin/python2.7 ./buildtools/bin/waf -v
build.pre_args
build.env-append \
                DESTDIR=${destroot}
destroot.cmd    ${prefix}/bin/python2.7 ./buildtools/bin/waf -v
destroot.env-append \
                DESTDIR=${destroot}
destroot.destdir

configure.args  -C \
                --enable-fhs \
                --enable-gnutls \
                --mandir=${prefix}/share/man \
                --with-libiconv=${prefix} \
                --without-acl-support \
                --without-ad-dc \
                --disable-avahi \
                --with-gpgme \
                --disable-spotlight

platform linux {
#     configure.args-append \
#                 --disable-rpath \
#                 --disable-rpath-install \
#                 --disable-rpath-private-install
}

variant concurrent description {Build for concurrent installation with port:samba3. Otherwise the port will use its normal install layout.} {}
if {![variant_isset concurrent]} {
    conflicts   samba3
} else {
    configure.args-append \
                --libdir=${prefix}/lib/${name} \
                --with-configdir=${prefix}/etc/${name}
}

variant spotlight description "Enable Spotlight support" {
    configure.args-replace \
                --disable-spotlight \
                --enable-spotlight
    platform darwin {
        depends_lib-append \
                port:tracker
    }
}

variant avahi description "Enable Avahi support" {
    configure.args-replace \
                --disable-avahi \
                --enable-avahi
    platform darwin {
        depends_lib-append port:avahi
    }
}

variant kerberos description "Enable Kerberos support" {
    configure.args-append \
                --with-system-mitkrb5
    platform darwin {
        depends_lib-append port:kerberos5
    }
}

platform linux {
    configure.args-replace \
                --without-acl-support \
                --with-acl-support
    depends_lib-append \
                port:attr \
                port:acl
    default_variants +avahi
    configure.ldflags-append \
                -L${prefix}/lib -lintl
}

configure.post_args-append "|& tee -a ${workpath}/.macports.${subport}.configure.log'"
pre-configure {
    set cmd [join "${configure.cmd} ${configure.pre_args} ${configure.args}"]
        configure.pre_args-prepend "-cf '${configure.cmd} "
        configure.cmd "/bin/csh"
        ui_debug "configure command set to `${configure.cmd} ${configure.pre_args} ${configure.args} ${configure.post_args}`"
        system "echo '## ${cmd}' > ${workpath}/.macports.${subport}.configure.log"
}

build.post_args-append -k

proc mkpdir {path perms} {
    global destroot prefix
    xinstall -m ${perms} -d ${destroot}${prefix}/${path}
    destroot.keepdirs-append ${destroot}${prefix}/${path}
}

post-destroot {
    ## TODO: need to install extra manpages from manpages/*.1 ?!
    xinstall -m 755 -d ${destroot}${prefix}/share/man/man5
    foreach m [glob -directory "${worksrcpath}/docs/manpages/" *.5] {
        xinstall ${m} ${destroot}${prefix}/share/man/man5/
    }

    # create required runtime directories with the appropriate permissions
    mkpdir var/lib/samba/private 755
    mkpdir var/lib/samba/private/msg.sock 700
    mkpdir var/cache/samba 755
    mkpdir var/run/samba 755
    mkpdir var/lock/samba/msg.lock 755

    if {[variant_isset concurrent]} {
        set samba "samba3"
        xinstall -m 755 -d ${destroot}${prefix}/etc/${name}/
        xinstall -m 644 ${worksrcpath}/examples/smb.conf.default \
            ${destroot}${prefix}/etc/${name}/smb.conf.sample
        system "touch ${destroot}${prefix}/etc/${name}/lmhosts.sample"

        foreach p [glob -directory ${destroot}${prefix}/lib/pkgconfig *.pc] {
            file rename ${p} ${destroot}${prefix}/lib/pkgconfig/${pc}4.pc
        }
    } else {
        set samba "samba"
        xinstall -m 755 -d ${destroot}${prefix}/etc/samba
        xinstall -m 644 ${worksrcpath}/examples/smb.conf.default \
            ${destroot}${prefix}/etc/samba/smb.conf.sample
        system "touch ${destroot}${prefix}/etc/samba/lmhosts.sample"
        # install symlinks so that existing dependents continue to find their dependents
        xinstall -m 755 -d ${destroot}${prefix}/lib/samba3
        ln -s ../libnetapi.dylib ${destroot}${prefix}/lib/samba3/
        ln -s ../libnetapi.0.dylib ${destroot}${prefix}/lib/samba3/libnetapi.dylib.0
        ln -s ../libsmbclient.dylib ${destroot}${prefix}/lib/samba3
        ln -s ../libsmbclient.0.dylib ${destroot}${prefix}/lib/samba3/libsmbclient.dylib.0
        foreach p [glob -directory ${destroot}${prefix}/lib/pkgconfig *.pc] {
            set pc [file rootname [file tail ${p}]]
            ln -s ${pc}.pc ${destroot}${prefix}/lib/pkgconfig/${pc}4.pc
        }
    }
    system "touch ${destroot}${prefix}/var/lib/samba/private/secrets.tdb.sample"

#     platform darwin {
#         set changeline "\
#             -change bin/libnetapi.0.dylib ${prefix}/lib/${samba}/libnetapi.dylib \
#             -change bin/libsmbclient.0.dylib ${prefix}/lib/${samba}/libsmbclient.dylib \
#             -change bin/libsmbsharemodes.0.dylib ${prefix}/lib/${samba}/libsmbsharemodes.dylib \
#             -change bin/libtalloc.dylib.2 ${prefix}/lib/${samba}/libtalloc.dylib \
#             -change bin/libtevent.0.dylib ${prefix}/lib/${samba}/libtevent.dylib \
#             -change bin/libtdb.dylib.1 ${prefix}/lib/${samba}/libtdb.dylib \
#             -change bin/script.dylib ${prefix}/lib/${samba}/auth/script.dylib \
#             -change bin/CP437.dylib ${prefix}/lib/${samba}/charset/CP437.dylib \
#             -change bin/CP850.dylib ${prefix}/lib/${samba}/charset/CP850.dylib \
#             -change bin/macosxfs.dylib ${prefix}/lib/${samba}/charset/macosxfs.dylib \
#             -change bin/autorid.dylib ${prefix}/lib/${samba}/idmap/autorid.dylib \
#             -change bin/pam_smbpass.dylib ${prefix}/lib/${samba}/security/pam_smbpass.dylib \
#             -change bin/acl_tdb.dylib ${prefix}/lib/${samba}/vfs/acl_tdb.dylib \
#             -change bin/acl_xattr.dylib ${prefix}/lib/${samba}/vfs/acl_xattr.dylib \
#             -change bin/audit.dylib ${prefix}/lib/${samba}/vfs/audit.dylib \
#             -change bin/cap.dylib ${prefix}/lib/${samba}/vfs/cap.dylib \
#             -change bin/catia.dylib ${prefix}/lib/${samba}/vfs/catia.dylib \
#             -change bin/crossrename.dylib ${prefix}/lib/${samba}/vfs/crossrename.dylib \
#             -change bin/default_quota.dylib ${prefix}/lib/${samba}/vfs/default_quota.dylib \
#             -change bin/expand_msdfs.dylib ${prefix}/lib/${samba}/vfs/expand_msdfs.dylib \
#             -change bin/extd_audit.dylib ${prefix}/lib/${samba}/vfs/extd_audit.dylib \
#             -change bin/fake_perms.dylib ${prefix}/lib/${samba}/vfs/fake_perms.dylib \
#             -change bin/full_audit.dylib ${prefix}/lib/${samba}/vfs/full_audit.dylib \
#             -change bin/linux_xfs_sgid.dylib ${prefix}/lib/${samba}/vfs/linux_xfs_sgid.dylib \
#             -change bin/netatalk.dylib ${prefix}/lib/${samba}/vfs/netatalk.dylib \
#             -change bin/preopen.dylib ${prefix}/lib/${samba}/vfs/preopen.dylib \
#             -change bin/readahead.dylib ${prefix}/lib/${samba}/vfs/readahead.dylib \
#             -change bin/readonly.dylib ${prefix}/lib/${samba}/vfs/readonly.dylib \
#             -change bin/recycle.dylib ${prefix}/lib/${samba}/vfs/recycle.dylib \
#             -change bin/scannedonly.dylib ${prefix}/lib/${samba}/vfs/scannedonly.dylib \
#             -change bin/shadow_copy.dylib ${prefix}/lib/${samba}/vfs/shadow_copy.dylib \
#             -change bin/shadow_copy2.dylib ${prefix}/lib/${samba}/vfs/shadow_copy2.dylib \
#             -change bin/smb_traffic_analyzer.dylib ${prefix}/lib/${samba}/vfs/smb_traffic_analyzer.dylib \
#             -change bin/streams_depot.dylib ${prefix}/lib/${samba}/vfs/streams_depot.dylib \
#             -change bin/streams_xattr.dylib ${prefix}/lib/${samba}/vfs/streams_xattr.dylib \
#             -change bin/time_audit.dylib ${prefix}/lib/${samba}/vfs/time_audit.dylib \
#             -change bin/xattr_tdb.dylib ${prefix}/lib/${samba}/vfs/xattr_tdb.dylib"
#
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/libnetapi.dylib ${destroot}${prefix}/lib/${samba}/libnetapi.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/libsmbclient.dylib ${destroot}${prefix}/lib/${samba}/libsmbclient.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/libsmbsharemodes.dylib ${destroot}${prefix}/lib/${samba}/libsmbsharemodes.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/libtalloc.dylib ${destroot}${prefix}/lib/${samba}/libtalloc.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/libtevent.dylib ${destroot}${prefix}/lib/${samba}/libtevent.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/libtdb.dylib ${destroot}${prefix}/lib/${samba}/libtdb.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/auth/script.dylib ${destroot}${prefix}/lib/${samba}/auth/script.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/charset/CP437.dylib ${destroot}${prefix}/lib/${samba}/charset/CP437.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/charset/CP850.dylib ${destroot}${prefix}/lib/${samba}/charset/CP850.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/charset/macosxfs.dylib ${destroot}${prefix}/lib/${samba}/charset/macosxfs.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/idmap/autorid.dylib ${destroot}${prefix}/lib/${samba}/idmap/autorid.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/security/pam_smbpass.dylib ${destroot}${prefix}/lib/${samba}/security/pam_smbpass.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/acl_tdb.dylib ${destroot}${prefix}/lib/${samba}/vfs/acl_tdb.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/acl_xattr.dylib ${destroot}${prefix}/lib/${samba}/vfs/acl_xattr.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/audit.dylib ${destroot}${prefix}/lib/${samba}/vfs/audit.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/cap.dylib ${destroot}${prefix}/lib/${samba}/vfs/cap.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/catia.dylib ${destroot}${prefix}/lib/${samba}/vfs/catia.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/crossrename.dylib ${destroot}${prefix}/lib/${samba}/vfs/crossrename.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/default_quota.dylib ${destroot}${prefix}/lib/${samba}/vfs/default_quota.dylib"
#         if {[file exists ${destroot}${prefix}/lib/${samba}/vfs/dirsort.dylib]} {
#             system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/dirsort.dylib ${destroot}${prefix}/lib/${samba}/vfs/dirsort.dylib"
#         }
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/expand_msdfs.dylib ${destroot}${prefix}/lib/${samba}/vfs/expand_msdfs.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/extd_audit.dylib ${destroot}${prefix}/lib/${samba}/vfs/extd_audit.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/fake_perms.dylib ${destroot}${prefix}/lib/${samba}/vfs/fake_perms.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/full_audit.dylib ${destroot}${prefix}/lib/${samba}/vfs/full_audit.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/linux_xfs_sgid.dylib ${destroot}${prefix}/lib/${samba}/vfs/linux_xfs_sgid.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/netatalk.dylib ${destroot}${prefix}/lib/${samba}/vfs/netatalk.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/preopen.dylib ${destroot}${prefix}/lib/${samba}/vfs/preopen.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/readahead.dylib ${destroot}${prefix}/lib/${samba}/vfs/readahead.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/readonly.dylib ${destroot}${prefix}/lib/${samba}/vfs/readonly.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/recycle.dylib ${destroot}${prefix}/lib/${samba}/vfs/recycle.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/scannedonly.dylib ${destroot}${prefix}/lib/${samba}/vfs/scannedonly.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/shadow_copy.dylib ${destroot}${prefix}/lib/${samba}/vfs/shadow_copy.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/shadow_copy2.dylib ${destroot}${prefix}/lib/${samba}/vfs/shadow_copy2.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/smb_traffic_analyzer.dylib ${destroot}${prefix}/lib/${samba}/vfs/smb_traffic_analyzer.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/streams_depot.dylib ${destroot}${prefix}/lib/${samba}/vfs/streams_depot.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/streams_xattr.dylib ${destroot}${prefix}/lib/${samba}/vfs/streams_xattr.dylib"
#         if {[file exists ${destroot}${prefix}/lib/${samba}/vfs/syncops.dylib]} {
#             system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/syncops.dylib ${destroot}${prefix}/lib/${samba}/vfs/syncops.dylib"
#         }
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/time_audit.dylib ${destroot}${prefix}/lib/${samba}/vfs/time_audit.dylib"
#         system "install_name_tool ${changeline} -id ${prefix}/lib/${samba}/vfs/xattr_tdb.dylib ${destroot}${prefix}/lib/${samba}/vfs/xattr_tdb.dylib"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/eventlogadm"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/net"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/nmblookup"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/ntlm_auth"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/pdbedit"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/profiles"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/rpcclient"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/sharesec"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/smbcacls"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/smbclient"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/smbcontrol"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/smbcquotas"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/smbget"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/smbpasswd"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/smbspool"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/smbstatus"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/smbta-util"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/smbtree"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/tdbbackup"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/tdbdump"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/tdbrestore"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/tdbtool"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/bin/testparm"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/sbin/nmbd"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/sbin/smbd"
#         system "install_name_tool ${changeline} ${destroot}${prefix}/sbin/swat"
#     }
}

livecheck.type  regex
livecheck.regex samba-(\[0-9a-z.\]+)\\.tar\\.gz

# kate: backspace-indents true; indent-pasted-text true; indent-width 4; keep-extra-spaces true; remove-trailing-spaces modified; replace-tabs true; replace-tabs-save true; syntax Tcl/Tk; tab-indents true; tab-width 4;
