PortSystem      1.0
PortGroup       code-sign 1.0

name            samba4
version         4.8.9
categories      net
platforms       darwin
maintainers     openmaintainer
license         GPL-3
description     SMB/CIFS server and client
long_description \
                Samba is the standard Windows interoperability suite of programs for Linux and Unix.

conflicts       samba3

homepage        http://www.samba.org/
master_sites    https://download.samba.org/pub/samba/stable
distname        samba-${version}
checksums       rmd160  24b661c5a2ead293ce4003b71072d321f34ece69 \
                sha256  ad2acf6bed436c125314a054f0589308eb664ac3d96cfb02d05e654a44e09c80
#                 size    17750151

depends_build   port:python27 \
                port:py27-orbit

depends_lib     port:gnutls \
                port:readline \
                port:libarchive \
                port:libiconv \
                port:popt \
                port:zlib \
                port:gettext \
                port:avahi \
                port:openldap \
                port:jansson \
                port:gpgme \
                port:py27-pygpgme

patch.pre_args  -Np1
patchfiles-append \
                patch-nss-test.diff \
                patch-no-attributes_h.diff \
                patch-xml-catalog.diff
# disable the build in the docs-xml dir which fails on docs-xml/manpages/smb.conf.5.xml :
# runtime error: file file:/opt/local/share/xsl/docbook-xsl-nons/lib/lib.xsl line 54 element choose
# xsltApplySequenceConstructor: A potential infinite template recursion was detected.
patchfiles-append \
                patch-no-docs_xml.diff

post-patch {
    reinplace -W ${worksrcpath} "s|@PREFIX@|${prefix}|g" \
                release-scripts/build-docs \
                release-scripts/build-htmlman-git \
                release-scripts/build-htmlman-nogit \
                release-scripts/build-manpages-git \
                release-scripts/build-manpages-nogit
}

# worksrcdir      samba-${version}/source

configure.env   PYTHON=${prefix}/bin/python2.7
configure.args  -C \
                --enable-fhs \
                --enable-gnutls \
                --mandir=${prefix}/share/man \
                --with-libiconv=${prefix} \
                --without-acl-support \
                --without-ad-dc \
                --disable-avahi \
                --without-system-mitkrb5 \
                --with-gpgme

# variant spotlight description "Enable Spotlight support" {
#     configure.args-append \
#                 --enable-spotlight
#     depends_lib-append \
#                 port:tracker
# }

variant avahi description "Enable Avahi support" {
    configure.args-replace \
                --disable-avahi \
                --enable-avahi
    depends_lib-append port:avahi
}

variant kerberos description "Enable Kerberos support" {
    configure.args-replace \
                --without-system-mitkrb5 \
                --with-system-mitkrb5
    depends_lib-append port:kerberos5
}

configure.post_args-append "|& tee -a ${workpath}/.macports.${subport}.configure.log'"
pre-configure {
    set cmd [join "${configure.cmd} ${configure.pre_args} ${configure.args}"]
        configure.pre_args-prepend "-cf '${configure.cmd} "
        configure.cmd "/bin/csh"
        ui_debug "configure command set to `${configure.cmd} ${configure.pre_args} ${configure.args} ${configure.post_args}`"
        system "echo '## ${cmd}' > ${workpath}/.macports.${subport}.configure.log"
}

build.post_args-append -wk V=1 VERBOSE=1

post-destroot {
    xinstall -m 755 -d ${destroot}${prefix}/share/man/man5
    foreach m [glob -directory "${worksrcpath}/docs/manpages/" *.5] {
        xinstall ${m} ${destroot}${prefix}/share/man/man5/
    }
}

livecheck.type  regex
livecheck.regex samba-(\[0-9a-z.\]+)\\.tar\\.gz

# kate: backspace-indents true; indent-pasted-text true; indent-width 4; keep-extra-spaces true; remove-trailing-spaces modified; replace-tabs true; replace-tabs-save true; syntax Tcl/Tk; tab-indents true; tab-width 4;
