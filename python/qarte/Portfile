# -*- coding: utf-8; mode: tcl; tab-width: 4; truncate-lines: t; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# kate: backspace-indents true; indent-pasted-text true; indent-width 4; keep-extra-spaces true; remove-trailing-spaces modified; replace-tabs true; replace-tabs-save true; syntax Tcl/Tk; tab-indents true; tab-width 4;

PortSystem          1.0

name                qarte

description         Qarte allow you to browse the archives of the Arte+7 and ArteLiveWeb \
                    sites and download the available videos.
long_description    ${description}

platforms           darwin
license             GPL-3
maintainers         @RJVB

homepage            https://launchpad.net/qarte

installs_libs       no
supported_archs     noarch

use_configure       no

subport ${name}3 {}

if {${subport} eq "${name}"} {
    conflicts           ${name}3
    fetch.type          bzr
    bzr.url             lp:qarte
    bzr.revision        158

    version             2.8.0

    categories          python kde kde4

    depends_run-append  port:python27 port:py27-pykde4 port:rtmpdump

    variant notify description {Runtime support for desktop notifications} {
        # specify py27-pygtk as an explicit dependency so interested users
        # know they will potentially be pulling in GTk2
        depends_run-append  port:py27-pygtk port:py27-notify-python
    }

    patchfiles-append   fix_unicode_issues.diff

    post-patch {
        reinplace -W ${build.dir} "s|/usr/bin/qarte|${prefix}/bin/qarte|g" differedTask.py
        reinplace -W ${build.dir} "s|#\!/usr/bin/env python|#\!${prefix}/bin/python2.7|" qarte.py
        reinplace -W ${build.dir} "s|#\! /usr/bin/python|#\!${prefix}/bin/python2.7|" qarte
        reinplace -W ${build.dir} "s|\"/usr/share|\"${prefix}/share|" qarte
        reinplace -W ${build.dir} "s|'/usr/share|'${prefix}/share|" qarte qarte.py
        foreach o [glob -nocomplain ${worksrcpath}/*.orig] {
            delete ${o}
        }
    }

    build {}

    destroot {
        copy ${build.dir} ${destroot}${prefix}/share/qarte
        delete ${destroot}${prefix}/share/qarte/qarte
        delete -force ${destroot}${prefix}/share/qarte/.bzr
        xinstall -m 0755 ${build.dir}/qarte ${destroot}${prefix}/bin
    }

    livecheck.type      regex
    livecheck.version   ${bzr.revision}
    livecheck.regex     >(\\d+)<
    livecheck.url       https://code.launchpad.net/~vincent-vandevyvre/qarte/trunk
} else {
    conflicts           ${name}
#     fetch.type          bzr
#     bzr.url             lp:qarte/qarte-3
#     bzr.revision        156

    version             3.5.0
    master_sites        http://ppa.launchpad.net/vincent-vandevyvre/vvv/ubuntu/pool/main/q/qarte/
    distname            ${name}_${version}
    extract.suffix      .orig.tar.gz
    checksums           rmd160  04398242cdac6e49b45c24cefa7cd0e309192a28 \
                        sha256  8485cd0889379edcbc8bac395caa515f421cb045176c60bbf6ca345905a79203
    worksrcdir          ${name}-${version}

    categories          python

    variant py34 conflicts py35 description {build for python-3.4} {
        depends_run-append \
                        port:python34 port:py34-pyqt5
        post-patch {
            reinplace -W ${build.dir} "s|#\! /usr/bin/python3|#\!${prefix}/bin/python3.4|" qarte
        }
    }
    variant py35 conflicts py34 description {build for python-3.5} {
        depends_run-append \
                        port:python35 port:py35-pyqt5
        post-patch {
            reinplace -W ${build.dir} "s|#\! /usr/bin/python3|#\!${prefix}/bin/python3.5|" qarte
        }
    }
    if {![variant_isset py34] && ![variant_isset py35]} {
        long_description-append \
                    A Python variant must be specified.
        pre-fetch {
            ui_msg "You must specify a Python variant"
            return -code error "Missing Python variant"
        }
    }

    patchfiles-append   patch-set-session-version.diff \
                        patch-qarte3-homevincent.diff \
                        patch-qarte3-unicode_issues.diff

    post-patch {
    #     reinplace -W ${build.dir} "s|/usr/bin/qarte|${prefix}/bin/qarte|g" differedTask.py
        reinplace -W ${build.dir} "s|\"/usr/share|\"${prefix}/share|" qarte
        reinplace -W ${build.dir} "s|'/usr/share|'${prefix}/share|" qarte core.py
        foreach o [glob -nocomplain ${worksrcpath}/*.orig] {
            delete ${o}
        }
    }

    build {}

    destroot {
        # qarte /usr/bin
        # q_arte.desktop /usr/share/applications
        # locale/* /usr/share/locale
        # qarte.png /usr/share/pixmaps
        # gui/*.py /usr/share/qarte/gui
        # gui/VWidgets_qt5/*.py /usr/share/qarte/gui/VWidgets_qt5
        # gui/commonwidgets/*.py /usr/share/qarte/gui/commonwidgets
        # medias/* /usr/share/qarte/medias
        # *.py /usr/share/qarte
        xinstall -m 0755 ${build.dir}/qarte ${destroot}${prefix}/bin
        xinstall -m 0755 -d ${destroot}${prefix}/share/applications
        xinstall -m 755 ${build.dir}/q_arte.desktop ${destroot}${prefix}/share/applications/
        xinstall -m 0755 -d ${destroot}${prefix}/share/pixmaps
        xinstall -m 755 ${build.dir}/qarte.png ${destroot}${prefix}/share/pixmaps/
        xinstall -m 0755 -d ${destroot}${prefix}/share/qarte/gui
        xinstall -m 0755 -d ${destroot}${prefix}/share/qarte/gui/VWidgets_qt5
        xinstall -m 0755 -d ${destroot}${prefix}/share/qarte/gui/commonwidgets
        xinstall -m 0755 -d ${destroot}${prefix}/share/qarte/medias
        foreach p [glob ${build.dir}/gui/*.py] {
            xinstall -m 0755 ${p} ${destroot}${prefix}/share/qarte/gui/
        }
        foreach p [glob ${build.dir}/gui/VWidgets_qt5/*.py] {
            xinstall -m 0755 ${p} ${destroot}${prefix}/share/qarte/gui/VWidgets_qt5/
        }
        foreach p [glob ${build.dir}/gui/commonwidgets/*.py] {
            xinstall -m 0755 ${p} ${destroot}${prefix}/share/qarte/gui/commonwidgets/
        }
        foreach p [glob ${build.dir}/medias/*] {
            xinstall -m 0755 ${p} ${destroot}${prefix}/share/qarte/medias/
        }
        foreach p [glob ${build.dir}/*.py] {
            xinstall -m 0755 ${p} ${destroot}${prefix}/share/qarte/
        }
    }

    livecheck.url       ${master_sites}
    livecheck.regex     "qarte_(\\d+(?:\\.\\d+)*)\\.orig"
}

